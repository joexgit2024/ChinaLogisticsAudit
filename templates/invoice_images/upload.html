{% extends "base.html" %}

{% block title %}Upload Invoice Image{% endblock %}

{% block content %}
<style>
    .upload-zone {
        border: 2px dashed #dee2e6;
        border-radius: 10px;
        padding: 40px;
        text-align: center;
        background: #f8f9fa;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    .upload-zone:hover, .upload-zone.dragover {
        border-color: #0d6efd;
        background: #e7f3ff;
    }
    .upload-zone.dragover {
        border-style: solid;
    }
    .file-preview {
        max-width: 100%;
        max-height: 300px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .preview-container {
            text-align: center;
            margin-top: 20px;
        }
        .invoice-type-selector {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
    .type-option {
        padding: 15px;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
    }
    .type-option:hover {
        border-color: #0d6efd;
        background: #f8f9fa;
    }
    .type-option.selected {
        border-color: #0d6efd;
        background: #e7f3ff;
    }
    .form-section {
        background: #fff;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
</style>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0">
        <i class="fas fa-upload me-2"></i>Upload Invoice Image
    </h1>
    <a href="{{ url_for('images.invoice_images_dashboard') }}" class="btn btn-outline-primary">
        <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
    </a>
</div>

<div class="row justify-content-center">
            <div class="col-lg-8">
                <!-- Header -->
                <div class="mb-4">
                    <h2><i class="fas fa-upload text-primary me-2"></i>Upload Invoice Image</h2>
                    <p class="text-muted">Upload images for DHL Express or DGF invoices</p>
                </div>

                <!-- Flash Messages -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                <form method="POST" enctype="multipart/form-data" id="uploadForm">
                    <!-- Invoice Type Selection -->
                    <div class="invoice-type-selector">
                        <h5 class="mb-3"><i class="fas fa-tag me-2"></i>Invoice Type</h5>
                        <p class="text-muted mb-3">
                            <strong>Please select whether this upload belongs to DHL Express or DGF invoices</strong>
                        </p>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="type-option" onclick="selectInvoiceType('DHL_EXPRESS')">
                                    <input type="radio" name="invoice_type" value="DHL_EXPRESS" id="dhl_express" required style="display: none;">
                                    <i class="fas fa-shipping-fast fa-2x text-success mb-2"></i>
                                    <h6>DHL Express</h6>
                                    <small class="text-muted">DHL Express invoices</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="type-option" onclick="selectInvoiceType('DGF')">
                                    <input type="radio" name="invoice_type" value="DGF" id="dgf" required style="display: none;">
                                    <i class="fas fa-file-invoice fa-2x text-info mb-2"></i>
                                    <h6>DGF Invoice</h6>
                                    <small class="text-muted">DGF invoices</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Invoice Number -->
                    <div class="form-section">
                        <h5 class="mb-3"><i class="fas fa-hashtag me-2"></i>Invoice Number</h5>
                        <div class="mb-3">
                            <label for="invoice_number" class="form-label">Invoice Number *</label>
                            <input type="text" class="form-control" id="invoice_number" name="invoice_number" 
                                   placeholder="Enter invoice number (e.g., MELR001510911)" required>
                            <div class="form-text">
                                Enter the exact invoice number as it appears on the invoice
                            </div>
                        </div>
                    </div>

                    <!-- File Upload -->
                    <div class="form-section">
                        <h5 class="mb-3"><i class="fas fa-file-upload me-2"></i>Upload Image</h5>
                        
                        <!-- Drag & Drop Zone -->
                        <div class="upload-zone" id="uploadZone" onclick="document.getElementById('file').click()">
                            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                            <h5>Drag & Drop or Click to Upload</h5>
                            <p class="text-muted mb-0">Supported formats: JPG, PNG, PDF, TIFF</p>
                            <p class="text-muted">Maximum file size: 10 MB</p>
                        </div>
                        
                        <input type="file" class="form-control d-none" id="file" name="file" 
                               accept=".jpg,.jpeg,.png,.pdf,.tiff,.tif" required>
                        
                        <!-- File Preview -->
                        <div id="filePreview" class="preview-container" style="display: none;">
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle me-2"></i>
                                <span id="fileName"></span>
                                <button type="button" class="btn-close float-end" onclick="clearFile()"></button>
                            </div>
                            <img id="previewImage" class="file-preview" style="display: none;">
                            <div id="pdfPreview" style="display: none;">
                                <i class="fas fa-file-pdf fa-5x text-danger mb-2"></i>
                                <p class="text-muted">PDF file selected</p>
                            </div>
                        </div>
                    </div>

                    <!-- Optional Description -->
                    <div class="form-section">
                        <h5 class="mb-3"><i class="fas fa-comment me-2"></i>Description (Optional)</h5>
                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" name="description" rows="3" 
                                      placeholder="Add any notes or description for this invoice image"></textarea>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                            <i class="fas fa-upload me-2"></i>Upload Invoice Image
                        </button>
                        <a href="{{ url_for('images.invoice_images_dashboard') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-2"></i>Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Invoice type selection
        function selectInvoiceType(type) {
            // Clear previous selections
            document.querySelectorAll('.type-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Select the clicked option
            document.querySelector(`input[value="${type}"]`).checked = true;
            document.querySelector(`input[value="${type}"]`).closest('.type-option').classList.add('selected');
        }

        // File upload handling
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('file');
        const filePreview = document.getElementById('filePreview');
        const fileName = document.getElementById('fileName');
        const previewImage = document.getElementById('previewImage');
        const pdfPreview = document.getElementById('pdfPreview');

        // Drag and drop events
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });

        uploadZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                handleFileSelect(files[0]);
            }
        });

        // File input change
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0]);
            }
        });

        function handleFileSelect(file) {
            fileName.textContent = file.name;
            filePreview.style.display = 'block';
            uploadZone.style.display = 'none';

            // Extract potential invoice number from filename using regex
            extractInvoiceNumberFromFilename(file.name);

            // Show appropriate preview
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImage.src = e.target.result;
                    previewImage.style.display = 'block';
                    pdfPreview.style.display = 'none';
                };
                reader.readAsDataURL(file);
            } else {
                previewImage.style.display = 'none';
                pdfPreview.style.display = 'block';
            }
        }

        function extractInvoiceNumberFromFilename(filename) {
            const invoiceNumberInput = document.getElementById('invoice_number');
            
            // Skip if user has already entered an invoice number
            if (invoiceNumberInput.value.trim() !== '') {
                return;
            }
            
            // Regex patterns for different invoice formats
            const patterns = [
                /J\d{7}/i,           // China format: J followed by 7 digits (J9835528)
                /SUZR\d{9}/i,        // DHL Express format: SUZR followed by 9 digits (SUZR001862880)
                /MEL\w{8,12}/i,      // General MEL format
                /\b[A-Z]\d{7,9}\b/i, // General: Letter followed by 7-9 digits
                /\b\d{7,10}\b/       // Fallback: 7-10 digits only
            ];
            
            let extractedNumber = null;
            
            // Try each pattern in order of preference
            for (const pattern of patterns) {
                const match = filename.match(pattern);
                if (match) {
                    extractedNumber = match[0].toUpperCase();
                    break;
                }
            }
            
            // If we found a potential invoice number, populate the field
            if (extractedNumber) {
                invoiceNumberInput.value = extractedNumber;
                
                // Add visual feedback with a small animation
                invoiceNumberInput.style.backgroundColor = '#e7f3ff';
                invoiceNumberInput.style.border = '2px solid #0d6efd';
                
                // Show a small notification
                const notification = document.createElement('div');
                notification.className = 'alert alert-info alert-dismissible fade show mt-2';
                notification.innerHTML = `
                    <i class="fas fa-magic me-2"></i>
                    <small>Auto-detected invoice number: <strong>${extractedNumber}</strong> from filename. You can edit if needed.</small>
                    <button type="button" class="btn-close btn-close-sm" data-bs-dismiss="alert"></button>
                `;
                
                // Insert notification after the invoice number input
                const invoiceSection = invoiceNumberInput.closest('.form-section');
                invoiceSection.appendChild(notification);
                
                // Auto-remove notification after 5 seconds
                setTimeout(() => {
                    if (notification && notification.parentNode) {
                        notification.remove();
                    }
                }, 5000);
                
                // Reset input styling after 2 seconds
                setTimeout(() => {
                    invoiceNumberInput.style.backgroundColor = '';
                    invoiceNumberInput.style.border = '';
                }, 2000);
            }
        }

        function clearFile() {
            fileInput.value = '';
            filePreview.style.display = 'none';
            uploadZone.style.display = 'block';
            previewImage.style.display = 'none';
            pdfPreview.style.display = 'none';
        }

        // Form submission with invoice type check
        document.getElementById('uploadForm').addEventListener('submit', function(e) {
            // Check if invoice type is selected
            const dhlChecked = document.getElementById('dhl_express').checked;
            const dgfChecked = document.getElementById('dgf').checked;
            
            if (!dhlChecked && !dgfChecked) {
                e.preventDefault(); // Prevent form submission
                
                // Remove any existing alert
                const existingAlert = document.getElementById('invoiceTypeAlert');
                if (existingAlert) {
                    existingAlert.remove();
                }
                
                // Create and show alert
                const alertDiv = document.createElement('div');
                alertDiv.id = 'invoiceTypeAlert';
                alertDiv.className = 'alert alert-danger alert-dismissible fade show';
                alertDiv.role = 'alert';
                alertDiv.innerHTML = `
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Invoice Type Required!</strong> 
                    Please select whether this upload belongs to DHL Express or DGF invoices before uploading.
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                
                // Insert alert at the top of the form container
                const formContainer = document.querySelector('.col-lg-8');
                const form = document.getElementById('uploadForm');
                formContainer.insertBefore(alertDiv, form);
                
                // Scroll to alert
                alertDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                return false;
            }
            
            // If invoice type is selected, proceed with upload
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Uploading...';
            submitBtn.disabled = true;
        });
    </script>
{% endblock %}
