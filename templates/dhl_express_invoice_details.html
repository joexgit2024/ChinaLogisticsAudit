{% extends "base.html" %}
{% block title %}DHL Express Invoice Details{% endblock %}

{% block content %}
<style>

        .nav-link {
            color: #D70018 !important;
            border-radius: 10px;
            margin: 0 5px;
        }
        .nav-link:hover {
            background-color: #D70018 !important;
            color: white !important;
        }
        .invoice-header {
            background: linear-gradient(135deg, #FF0000 0%, #D70018 100%);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }
        .line-item-row:hover {
            background-color: #fff5f5;
        }
        .btn-dhl {
            background-color: #D70018;
            border-color: #D70018;
            color: white;
        }
        .btn-dhl:hover {
            background-color: #B80015;
            border-color: #B80015;
            color: white;
        }
        .amount-highlight {
            font-weight: bold;
            color: #D70018;
        }
    
</style>

<div class="container-fluid">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/dhl-express">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="/dhl-express/invoices">Invoices</a></li>
                <li class="breadcrumb-item active">{{ header.invoice_no }}</li>
            </ol>
        </nav>

        <!-- Invoice Header -->
        <div class="invoice-header">
            <div class="row">
                <div class="col-md-8">
                    <h1><i class="fas fa-file-invoice"></i> Invoice {{ header.invoice_no }}</h1>
                    <p class="mb-2">
                        <strong>Company:</strong> {{ header.company_name }}<br>
                        <strong>Account:</strong> {{ header.account_number }}
                    </p>
                </div>
                <div class="col-md-4 text-end">
                    <h3>{{ header.invoice_date }}</h3>
                    <p class="mb-0">
                        <strong>{{ lines|length }} line items</strong><br>
                        Total: <span class="fs-4">${{ "{:,.2f}".format(lines|sum(attribute='amount')) }}</span>
                    </p>
                </div>
            </div>
        </div>

        <!-- Shipper and Receiver Information -->
        <div class="row mb-4">
            <!-- Shipper Details -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0"><i class="fas fa-truck"></i> Shipper Details</h6>
                    </div>
                    <div class="card-body">
                        {% if header.shipper and header.shipper.company %}
                            <h6 class="text-primary mb-2">{{ header.shipper.company }}</h6>
                            <div class="row">
                                <div class="col-12">
                                    {% if header.shipper.address1 %}
                                        <p class="mb-1"><strong>Address:</strong><br>
                                        {{ header.shipper.address1 }}
                                        {% if header.shipper.address2 and header.shipper.address2 != header.shipper.address1 %}
                                            <br>{{ header.shipper.address2 }}
                                        {% endif %}
                                        </p>
                                    {% endif %}
                                    
                                    {% if header.shipper.city or header.shipper.state or header.shipper.postal_code %}
                                        <p class="mb-1"><strong>Location:</strong><br>
                                        {{ header.shipper.city }}
                                        {% if header.shipper.city2 and header.shipper.city2 != header.shipper.city %}, {{ header.shipper.city2 }}{% endif %}
                                        {% if header.shipper.state %}, {{ header.shipper.state }}{% endif %}
                                        {% if header.shipper.postal_code %} {{ header.shipper.postal_code }}{% endif %}
                                        </p>
                                    {% endif %}
                                    
                                    {% if header.shipper.country %}
                                        <p class="mb-1"><strong>Country:</strong> {{ header.shipper.country }}</p>
                                    {% endif %}
                                    
                                    {% if header.shipper.contact %}
                                        <p class="mb-1"><strong>Contact:</strong> {{ header.shipper.contact }}</p>
                                    {% endif %}
                                    
                                    {% if header.shipper.email %}
                                        <p class="mb-0"><strong>Email:</strong> 
                                        <a href="mailto:{{ header.shipper.email }}">{{ header.shipper.email }}</a></p>
                                    {% endif %}
                                </div>
                            </div>
                        {% else %}
                            <p class="text-muted">No shipper details available</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Receiver Details -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0"><i class="fas fa-building"></i> Receiver Details</h6>
                    </div>
                    <div class="card-body">
                        {% if header.receiver and header.receiver.company %}
                            <h6 class="text-success mb-2">{{ header.receiver.company }}</h6>
                            <div class="row">
                                <div class="col-12">
                                    {% if header.receiver.address1 %}
                                        <p class="mb-1"><strong>Address:</strong><br>
                                        {{ header.receiver.address1 }}
                                        {% if header.receiver.address2 and header.receiver.address2 != header.receiver.address1 %}
                                            <br>{{ header.receiver.address2 }}
                                        {% endif %}
                                        </p>
                                    {% endif %}
                                    
                                    {% if header.receiver.city or header.receiver.state or header.receiver.postal_code %}
                                        <p class="mb-1"><strong>Location:</strong><br>
                                        {{ header.receiver.city }}
                                        {% if header.receiver.city2 and header.receiver.city2 != header.receiver.city %}, {{ header.receiver.city2 }}{% endif %}
                                        {% if header.receiver.state %}, {{ header.receiver.state }}{% endif %}
                                        {% if header.receiver.postal_code %} {{ header.receiver.postal_code }}{% endif %}
                                        </p>
                                    {% endif %}
                                    
                                    {% if header.receiver.country %}
                                        <p class="mb-1"><strong>Country:</strong> {{ header.receiver.country }}</p>
                                    {% endif %}
                                    
                                    {% if header.receiver.contact %}
                                        <p class="mb-1"><strong>Contact:</strong> {{ header.receiver.contact }}</p>
                                    {% endif %}
                                    
                                    {% if header.receiver.email %}
                                        <p class="mb-0"><strong>Email:</strong> 
                                        <a href="mailto:{{ header.receiver.email }}">{{ header.receiver.email }}</a></p>
                                    {% endif %}
                                </div>
                            </div>
                        {% else %}
                            <p class="text-muted">No receiver details available</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="row mb-4">
            <div class="col-12">
                <a href="/dhl-express/audit/{{ header.invoice_no }}" class="btn btn-dhl">
                    <i class="fas fa-search"></i> Audit This Invoice
                </a>
                {% if has_invoice_image %}
                    <a href="{{ url_for('images.view_invoice_image', invoice_type='DHL_EXPRESS', invoice_number=header.invoice_no) }}" 
                       class="btn btn-outline-warning">
                        <i class="fas fa-file-image"></i> View Invoice Image
                    </a>
                {% endif %}
                <button class="btn btn-outline-secondary" onclick="window.print()">
                    <i class="fas fa-print"></i> Print
                </button>
                <a href="/dhl-express/invoice/{{ header.invoice_no }}/download" class="btn btn-outline-info">
                    <i class="fas fa-download"></i> Download Excel
                </a>
                <a href="/dhl-express/invoices" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Back to List
                </a>
            </div>
        </div>

        <!-- Line Items -->
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-list"></i> Line Items</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Product Description</th>
                                <th>AWB Number</th>
                                <th>Weight (kg)</th>
                                <th>Route</th>
                                <th>Amount</th>
                                <th>Weight Charge</th>
                                <th>Discount</th>
                                <th>Tax</th>
                                <th>Ship Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for line in lines %}
                            <tr class="line-item-row">
                                <td><strong>{{ line.line_number }}</strong></td>
                                <td>
                                    <strong>{{ line.product_description }}</strong>
                                    {% if line.product_description == 'EXPRESS WORLDWIDE nondoc' %}
                                        <span class="badge bg-primary">Main Freight</span>
                                    {% elif 'FUEL SURCHARGE' in line.product_description %}
                                        <span class="badge bg-warning">Fuel</span>
                                    {% elif 'REMOTE AREA' in line.product_description %}
                                        <span class="badge bg-info">Remote</span>
                                    {% elif 'CHANGE OF BILLING' in line.product_description %}
                                        <span class="badge bg-secondary">Service</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <code>{{ line.awb_number }}</code>
                                </td>
                                <td>
                                    {% if line.weight %}
                                        {{ "{:.2f}".format(line.weight) }}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small>
                                        {{ line.origin_code }} →<br>
                                        {{ line.destination_code }}
                                    </small>
                                </td>
                                <td class="amount-highlight">
                                    ${{ "{:,.2f}".format(line.amount) }}
                                </td>
                                <td>
                                    {% if line.weight_charge %}
                                        ${{ "{:,.2f}".format(line.weight_charge) }}
                                    {% else %}
                                        <span class="text-muted">$0.00</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if line.discount_amount %}
                                        <span class="text-success">-${{ "{:,.2f}".format(line.discount_amount) }}</span>
                                    {% else %}
                                        <span class="text-muted">$0.00</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if line.tax_amount %}
                                        ${{ "{:,.2f}".format(line.tax_amount) }}
                                    {% else %}
                                        <span class="text-muted">$0.00</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small>{{ line.shipment_date if line.shipment_date else '-' }}</small>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr class="table-info">
                                <th colspan="5">Total</th>
                                <th class="amount-highlight">${{ "{:,.2f}".format(lines|sum(attribute='amount')) }}</th>
                                <th>${{ "{:,.2f}".format(lines|sum(attribute='weight_charge')) }}</th>
                                <th class="text-success">-${{ "{:,.2f}".format(lines|sum(attribute='discount_amount')) }}</th>
                                <th>${{ "{:,.2f}".format(lines|sum(attribute='tax_amount')) }}</th>
                                <th></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="row mt-4">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        {% set freight_lines = [] %}
                        {% for line in lines %}
                            {% if 'EXPRESS WORLDWIDE' in line.product_description %}
                                {% set _ = freight_lines.append(line) %}
                            {% endif %}
                        {% endfor %}
                        <h4 class="text-danger">{{ freight_lines|length }}</h4>
                        <p class="text-muted mb-0">Freight Lines</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        {% set fuel_lines = [] %}
                        {% for line in lines %}
                            {% if 'FUEL SURCHARGE' in line.product_description %}
                                {% set _ = fuel_lines.append(line) %}
                            {% endif %}
                        {% endfor %}
                        <h4 class="text-danger">{{ fuel_lines|length }}</h4>
                        <p class="text-muted mb-0">Fuel Surcharges</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        {% set other_lines = [] %}
                        {% for line in lines %}
                            {% if 'EXPRESS WORLDWIDE' not in line.product_description and 'FUEL SURCHARGE' not in line.product_description %}
                                {% set _ = other_lines.append(line) %}
                            {% endif %}
                        {% endfor %}
                        <h4 class="text-danger">{{ other_lines|length }}</h4>
                        <p class="text-muted mb-0">Other Charges</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h4 class="text-danger">{{ "{:.1f}".format(lines|sum(attribute='weight') or 0) }} kg</h4>
                        <p class="text-muted mb-0">Total Weight</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}