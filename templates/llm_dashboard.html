<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM-Enhanced PDF Processing - DHL Audit</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .status-processing { color: #ffc107; }
        .status-completed { color: #28a745; }
        .status-error { color: #dc3545; }
        .confidence-high { color: #28a745; font-weight: bold; }
        .confidence-medium { color: #ffc107; font-weight: bold; }
        .confidence-low { color: #dc3545; font-weight: bold; }
        .llm-card {
            border-left: 4px solid #17a2b8;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="fas fa-brain"></i>
                DHL Invoice Audit - LLM Enhanced Processing
            </a>
            <div class="navbar-nav flex-row">
                <a class="nav-link me-3" href="/advanced-pdf">Traditional Processing</a>
                <a class="nav-link me-3" href="/llm-pdf">LLM Processing</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Header Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card llm-card">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h2><i class="fas fa-brain"></i> LLM-Enhanced PDF Processing</h2>
                                <p class="mb-0">Using {{ llm_model }} for intelligent invoice data extraction</p>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="d-flex justify-content-end gap-2">
                                    <a href="/llm-pdf/process-all" class="btn btn-success">
                                        <i class="fas fa-magic"></i> Process All PDFs
                                    </a>
                                    <div class="dropdown">
                                        <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                            <i class="fas fa-cog"></i> Options
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="#" onclick="checkOllamaStatus()">Check LLM Status</a></li>
                                            <li><a class="dropdown-item" href="/llm-pdf/stats">View Statistics</a></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item" href="/advanced-pdf">Traditional Processing</a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">{{ total_processed }}</h5>
                        <p class="card-text">Total Processed</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-success">{{ high_confidence_count }}</h5>
                        <p class="card-text">High Confidence</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-warning">{{ needs_review_count }}</h5>
                        <p class="card-text">Needs Review</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">{{ "%.1f" | format(avg_confidence * 100) }}%</h5>
                        <p class="card-text">Avg Confidence</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Processing Results Table -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-table"></i> LLM Processing Results</h5>
                    </div>
                    <div class="card-body">
                        {% if extractions %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Invoice No</th>
                                        <th>PDF File</th>
                                        <th>Total Amount</th>
                                        <th>Currency</th>
                                        <th>Customer</th>
                                        <th>Confidence</th>
                                        <th>Processed</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for extraction in extractions %}
                                    <tr>
                                        <td>
                                            <strong>{{ extraction.invoice_no }}</strong>
                                            {% if extraction.manual_review_needed %}
                                            <span class="badge bg-warning ms-1">Review</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ extraction.pdf_filename }}</td>
                                        <td>
                                            {% if extraction.extracted_data and extraction.extracted_data.final_total %}
                                            ${{ extraction.extracted_data.final_total }}
                                            {% else %}
                                            <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if extraction.extracted_data and extraction.extracted_data.currency %}
                                            {{ extraction.extracted_data.currency }}
                                            {% else %}
                                            <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if extraction.extracted_data and extraction.extracted_data.customer_name %}
                                            {{ extraction.extracted_data.customer_name[:30] }}{% if extraction.extracted_data.customer_name|length > 30 %}...{% endif %}
                                            {% else %}
                                            <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% set confidence = extraction.extraction_confidence * 100 %}
                                            <span class="{% if confidence >= 80 %}confidence-high{% elif confidence >= 60 %}confidence-medium{% else %}confidence-low{% endif %}">
                                                {{ "%.1f" | format(confidence) }}%
                                            </span>
                                        </td>
                                        <td>
                                            <small>{{ extraction.processing_timestamp[:19] if extraction.processing_timestamp else '-' }}</small>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <a href="/llm-pdf/details/{{ extraction.invoice_no }}" class="btn btn-outline-primary btn-sm">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                <a href="/llm-pdf/compare/{{ extraction.pdf_filename }}" class="btn btn-outline-info btn-sm">
                                                    <i class="fas fa-balance-scale"></i>
                                                </a>
                                                <a href="/llm-pdf/reprocess/{{ extraction.invoice_no }}" class="btn btn-outline-warning btn-sm">
                                                    <i class="fas fa-redo"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-file-pdf fa-3x text-muted mb-3"></i>
                            <h5>No LLM Extractions Found</h5>
                            <p class="text-muted">Start by processing some PDF files with LLM enhancement.</p>
                            <a href="/llm-pdf/process-all" class="btn btn-primary">
                                <i class="fas fa-magic"></i> Process All PDFs
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Upload Section -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-upload"></i> Upload & Process New PDF</h5>
                    </div>
                    <div class="card-body">
                        <form action="/llm-pdf/upload" method="post" enctype="multipart/form-data">
                            <div class="row align-items-end">
                                <div class="col-md-6">
                                    <label for="pdf_file" class="form-label">Select PDF File</label>
                                    <input type="file" class="form-control" id="pdf_file" name="pdf_file" accept=".pdf" required>
                                </div>
                                <div class="col-md-4">
                                    <label for="invoice_no" class="form-label">Invoice Number (optional)</label>
                                    <input type="text" class="form-control" id="invoice_no" name="invoice_no" placeholder="Auto-detected if not provided">
                                </div>
                                <div class="col-md-2">
                                    <button type="submit" class="btn btn-success w-100">
                                        <i class="fas fa-brain"></i> Process with LLM
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Check Modal -->
    <div class="modal fade" id="statusModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">LLM Service Status</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="statusContent">
                        <div class="text-center">
                            <i class="fas fa-spinner fa-spin fa-2x"></i>
                            <p class="mt-2">Checking LLM service status...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://kit.fontawesome.com/your-fontawesome-kit.js"></script>
    <script>
        function checkOllamaStatus() {
            const modal = new bootstrap.Modal(document.getElementById('statusModal'));
            modal.show();
            
            fetch('/llm-pdf/status')
                .then(response => response.json())
                .then(data => {
                    const content = document.getElementById('statusContent');
                    if (data.available) {
                        content.innerHTML = `
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle"></i>
                                <strong>LLM Service Online</strong><br>
                                Model: ${data.model}<br>
                                URL: ${data.url}
                            </div>
                        `;
                    } else {
                        content.innerHTML = `
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>LLM Service Unavailable</strong><br>
                                Error: ${data.error}
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    document.getElementById('statusContent').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-times-circle"></i>
                            <strong>Connection Error</strong><br>
                            Could not check LLM service status.
                        </div>
                    `;
                });
        }
    </script>
</body>
</html>
