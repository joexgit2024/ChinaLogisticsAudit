{% extends "base.html" %}

{% block title %}YTD Batch Audit System{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">
                <i class="fas fa-chart-line text-primary"></i>
                YTD Batch Audit System
            </h1>
            
            <!-- System Status Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="card-title">{{ latest_batch_stats.get('latest_total', total_results) }}</h4>
                                    <p class="card-text">Latest Batch Results</p>
                                    <small class="text-light">{{ latest_batch_stats.get('latest_batch_name', 'No recent batch') }}</small>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-clipboard-list fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="card-title">{{ (latest_batch_stats.get('latest_passed', 0) + latest_batch_stats.get('latest_warned', 0)) or status_counts.get('APPROVED', 0) + status_counts.get('REVIEW_REQUIRED', 0) }}</h4>
                                    <p class="card-text">Approved & Reviews</p>
                                    <small class="text-light">{{ latest_batch_stats.get('latest_passed', 0) }} passed, {{ latest_batch_stats.get('latest_warned', 0) }} review</small>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-check-circle fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="card bg-danger text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="card-title">{{ latest_batch_stats.get('latest_failed', 0) or status_counts.get('REJECTED', 0) }}</h4>
                                    <p class="card-text">No Rate Card Match</p>
                                    <small class="text-light">No rate card found</small>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-exclamation-triangle fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="card bg-warning text-dark">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="card-title">{{ latest_batch_stats.get('latest_error', 0) or status_counts.get('ERROR', 0) }}</h4>
                                    <p class="card-text">System Errors</p>
                                    <small class="text-muted">Processing errors</small>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-bug fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-cogs"></i> Batch Audit Controls</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <!-- Run New Batch Audit -->
                                <div class="col-md-6">
                                    <form method="POST" action="{{ url_for('ytd_batch_audit.run_full_ytd_batch_audit') }}" id="batchAuditForm">
                                        <div class="mb-3">
                                            <label for="batch_name" class="form-label">Batch Name</label>
                                            <input type="text" class="form-control" id="batch_name" name="batch_name" 
                                                   placeholder="YTD Audit - Enter description">
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="limit" class="form-label">Limit Invoices (Optional)</label>
                                            <input type="number" class="form-control" id="limit" name="limit" 
                                                   placeholder="Leave empty to process all invoices" min="1">
                                            <div class="form-text">For testing, you can limit the number of invoices to process</div>
                                        </div>
                                        
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" id="force_reaudit" name="force_reaudit">
                                            <label class="form-check-label" for="force_reaudit">
                                                Force Re-audit (Re-process already audited invoices)
                                            </label>
                                        </div>
                                        
                                        <button type="submit" class="btn btn-primary btn-lg" id="runBatchBtn" onclick="console.log('Button clicked!')">
                                            <i class="fas fa-play"></i> Run Batch Audit
                                        </button>
                                    </form>
                                </div>
                                
                                <!-- Test Single Invoice -->
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="test_invoice" class="form-label">Test Single Invoice</label>
                                        <input type="text" class="form-control" id="test_invoice" 
                                               placeholder="Enter invoice number (e.g., D2106577)">
                                    </div>
                                    <button type="button" class="btn btn-outline-primary" onclick="testSingleInvoice()">
                                        <i class="fas fa-search"></i> Test Invoice Audit
                                    </button>
                                    
                                    <!-- Test Result Display -->
                                    <div id="testResult" class="mt-3" style="display: none;">
                                        <div class="card">
                                            <div class="card-body" id="testResultContent">
                                                <!-- Result will be populated here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Batch Runs -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-history"></i> Recent Batch Audit Runs</h5>
                        </div>
                        <div class="card-body">
                            {% if recent_batches %}
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>Description</th>
                                                <th>Status</th>
                                                <th>Invoices</th>
                                                <th>Results</th>
                                                <th>Processing Time</th>
                                                <th>Created</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for batch in recent_batches %}
                                            <tr>
                                                <td>{{ batch.get('id', 'N/A') }}</td>
                                                <td>{{ batch.get('description', 'N/A') }}</td>
                                                <td>
                                                    <span class="badge 
                                                        {% if batch.get('status') == 'completed' %}bg-success
                                                        {% elif batch.get('status') == 'running' %}bg-warning
                                                        {% else %}bg-danger{% endif %}">
                                                        {{ batch.get('status', 'unknown').title() }}
                                                    </span>
                                                </td>
                                                <td>{{ batch.get('total_invoices', 0) }}</td>
                                                <td>
                                                    <small>
                                                        <span class="text-success">W:{{ batch.get('warning_count', 0) }}</span>
                                                        <span class="text-danger">N:{{ batch.get('failed_count', 0) }}</span>
                                                        <span class="text-warning">E:{{ batch.get('error_count', 0) }}</span>
                                                    </small>
                                                </td>
                                                <td>{{ "%.2f"|format(batch.get('total_processing_time_ms', 0) / 1000) }}s</td>
                                                <td>{{ batch.get('created_at', 'N/A')[:16] if batch.get('created_at') else 'N/A' }}</td>
                                                <td>
                                                    <a href="{{ url_for('ytd_batch_audit.ytd_batch_audit_results', batch_id=batch.get('id')) }}" 
                                                       class="btn btn-sm btn-outline-primary">
                                                        <i class="fas fa-eye"></i> View
                                                    </a>
                                                    {% if batch.get('status') == 'completed' %}
                                                    <form method="POST" action="{{ url_for('ytd_batch_audit.delete_batch_audit', batch_id=batch.get('id')) }}" 
                                                          style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this batch audit?')">
                                                        <button type="submit" class="btn btn-sm btn-outline-danger">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </form>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="text-center py-4">
                                    <i class="fas fa-info-circle fa-3x text-muted mb-3"></i>
                                    <h5 class="text-muted">No batch audit runs found</h5>
                                    <p class="text-muted">Run your first batch audit to see results here.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5>Running Batch Audit...</h5>
                <p>This may take several minutes depending on the number of invoices.</p>
            </div>
        </div>
    </div>
</div>

<script>
// Auto-populate batch name with current timestamp
document.addEventListener('DOMContentLoaded', function() {
    const now = new Date();
    const timestamp = now.getFullYear() + '-' + 
                     String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                     String(now.getDate()).padStart(2, '0') + ' ' + 
                     String(now.getHours()).padStart(2, '0') + ':' + 
                     String(now.getMinutes()).padStart(2, '0');
    
    document.getElementById('batch_name').value = 'YTD Audit - ' + timestamp;
});

// Show loading modal when running batch audit
document.getElementById('batchAuditForm').addEventListener('submit', function(e) {
    console.log('Form submit event triggered');
    alert('Form is submitting!'); // Debug alert
    
    var loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
    loadingModal.show();
    
    // Disable the submit button
    document.getElementById('runBatchBtn').disabled = true;
});

// Test single invoice function
function testSingleInvoice() {
    const invoiceNo = document.getElementById('test_invoice').value.trim();
    if (!invoiceNo) {
        alert('Please enter an invoice number');
        return;
    }
    
    // Show loading
    const testResult = document.getElementById('testResult');
    const testResultContent = document.getElementById('testResultContent');
    testResultContent.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div><br>Testing invoice audit...</div>';
    testResult.style.display = 'block';
    
    // Make AJAX request
    fetch('/ytd-batch-audit/test-invoice', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'invoice_no=' + encodeURIComponent(invoiceNo)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            testResultContent.innerHTML = '<div class="alert alert-danger">' + data.error + '</div>';
        } else {
            // Format the result
            let statusClass = 'success';
            if (data.status === 'fail') statusClass = 'danger';
            else if (data.status === 'warning') statusClass = 'warning';
            else if (data.status === 'error') statusClass = 'secondary';
            
            testResultContent.innerHTML = `
                <h6><strong>Invoice:</strong> ${data.invoice_no}</h6>
                <p><span class="badge bg-${statusClass}">${data.status.toUpperCase()}</span></p>
                <p><strong>Mode:</strong> ${data.transportation_mode || 'N/A'}</p>
                <p><strong>Invoice Amount:</strong> $${(data.total_invoice_amount || 0).toLocaleString()}</p>
                <p><strong>Variance:</strong> $${(data.total_variance || 0).toLocaleString()} (${(data.variance_percent || 0).toFixed(2)}%)</p>
                <p><strong>Rate Cards Checked:</strong> ${data.rate_cards_checked || 0}</p>
                <p><strong>Processing Time:</strong> ${data.processing_time_ms || 0}ms</p>
                <a href="/ytd-batch-audit/invoice-detail/${data.invoice_no}" class="btn btn-sm btn-primary">View Details</a>
            `;
        }
    })
    .catch(error => {
        testResultContent.innerHTML = '<div class="alert alert-danger">Error: ' + error.message + '</div>';
    });
}
</script>
{% endblock %}
