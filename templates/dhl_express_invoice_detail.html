{% extends "base.html" %}
{% block title %}DHL Express Invoice Details{% endblock %}

{% block content %}
<style>
    .nav-link {
        color: #D70018 !important;
        border-radius: 10px;
        margin: 0 5px;
    }
    .nav-link:hover {
        background-color: #D70018 !important;
        color: white !important;
    }
    .invoice-header {
        background: linear-gradient(135deg, #FF0000 0%, #D70018 100%);
        color: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 20px;
    }
    .line-item-row:hover {
        background-color: #fff5f5;
    }
    .btn-dhl {
        background-color: #D70018;
        border-color: #D70018;
        color: white;
    }
    .btn-dhl:hover {
        background-color: #B80015;
        border-color: #B80015;
        color: white;
    }
    .amount-highlight {
        font-weight: bold;
        color: #D70018;
    }
    .chinese-badge {
        background-color: #ff6b35;
        color: white;
        border-radius: 12px;
        padding: 4px 12px;
        font-size: 0.8em;
        font-weight: bold;
    }
    .detail-section {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }
    .field-label {
        font-weight: bold;
        color: #666;
        margin-bottom: 5px;
    }
    .address-block {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
    }
</style>

<div class="container-fluid">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/dhl-express">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="/dhl-express/invoices">Invoices</a></li>
            <li class="breadcrumb-item active">{{ invoice_header.invoice_no }}</li>
        </ol>
    </nav>

    <!-- Invoice Header -->
    <div class="invoice-header">
        <div class="row">
            <div class="col-md-8">
                <h2>
                    <i class="fas fa-file-invoice"></i> Invoice {{ invoice_header.invoice_no }}
                    {% if is_chinese %}
                        <span class="chinese-badge">中国 CN</span>
                    {% else %}
                        <span class="badge badge-light">AU</span>
                    {% endif %}
                </h2>
                <p class="mb-1"><strong>Company:</strong> {{ invoice_header.company_name }}</p>
                <p class="mb-1"><strong>Account:</strong> {{ invoice_header.account_number }}</p>
                <p class="mb-1"><strong>Date:</strong> {{ invoice_header.invoice_date }}</p>
                {% if has_invoice_image %}
                <p class="mb-0">
                    <a href="{{ url_for('images.view_invoice_image', invoice_type='DHL_EXPRESS', invoice_number=invoice_header.invoice_no) }}" 
                       class="btn btn-sm btn-outline-light" target="_blank">
                        <i class="fas fa-image me-1"></i> View Invoice Image
                    </a>
                </p>
                {% endif %}
            </div>
            <div class="col-md-4 text-right">
                {% if is_chinese %}
                    <h4>{{ invoice_header.currency or 'CNY' }}</h4>
                    <h3 class="mb-1">{{ "%.2f"|format(invoice_header.total_lcu) }}</h3>
                    {% if invoice_header.total_bcu != invoice_header.total_lcu %}
                        <small>BCU: {{ "%.2f"|format(invoice_header.total_bcu) }}</small>
                    {% endif %}
                {% else %}
                    <h4>{{ invoice_header.currency or 'AUD' }}</h4>
                    <h3 class="mb-1">{{ "%.2f"|format(invoice_lines|sum(attribute='amount')) }}</h3>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Chinese Invoice Details -->
    {% if is_chinese %}
        <div class="row">
            <!-- Invoice Level Information -->
            <div class="col-md-6">
                <div class="detail-section">
                    <h5><i class="fas fa-info-circle"></i> Invoice Information</h5>
                    {% set first_line = invoice_lines[0] %}
                    <p><strong>Bill To Account:</strong> {{ first_line.bill_to_account or 'N/A' }}</p>
                    <p><strong>Billing Currency:</strong> {{ first_line.billing_currency or 'N/A' }}</p>
                    <p><strong>Local Currency:</strong> {{ first_line.local_currency or 'N/A' }}</p>
                    {% if first_line.exchange_rate and first_line.exchange_rate != 1 %}
                        <p><strong>Exchange Rate:</strong> {{ first_line.exchange_rate }}</p>
                    {% endif %}
                    <p><strong>Service Type:</strong> {{ first_line.service_type or 'N/A' }}</p>
                    <p><strong>Product Code:</strong> {{ first_line.local_product_code or 'N/A' }}</p>
                </div>
            </div>
            
            <!-- Common Consignee Information -->
            <div class="col-md-6">
                <div class="detail-section">
                    <h5><i class="fas fa-building"></i> Common Consignee</h5>
                    <div class="address-block">
                        <strong>{{ first_line.consignee_name or 'N/A' }}</strong><br>
                        {{ first_line.consignee_contact_name or '' }}<br>
                        {{ first_line.consignee_address_1 or '' }}<br>
                        {% if first_line.consignee_address_2 %}{{ first_line.consignee_address_2 }}<br>{% endif %}
                        {{ first_line.consignee_city or '' }}, {{ first_line.consignee_province_state or '' }} {{ first_line.consignee_postal_code or '' }}<br>
                        {{ first_line.consignee_country or '' }}
                    </div>
                </div>
            </div>
        </div>

        <!-- Shipment Details Table -->
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-list"></i> Shipment Details ({{ invoice_lines|length }} shipments)</h5>
                <small class="text-muted">Each row represents an individual shipment with its own shipper and routing</small>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="thead-dark">
                            <tr>
                                <th>AWB</th>
                                <th>Unique Record ID</th>
                                <th>Consignor (Shipper)</th>
                                <th>Shipper Account</th>
                                <th>Reference</th>
                                <th>Route</th>
                                <th>Weight (kg)</th>
                                <th>Pieces</th>
                                <th>BCU Total</th>
                                <th>LCU Total</th>
                                <th>Ship Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for line in invoice_lines %}
                            <tr class="line-item-row">
                                <td>
                                    <strong>{{ line.air_waybill or 'N/A' }}</strong>
                                </td>
                                <td>
                                    <small><code>{{ line.unique_record_id or 'N/A' }}</code></small>
                                </td>
                                <td>
                                    <strong>{{ line.consignor_name or 'N/A' }}</strong>
                                    {% if line.consignor_contact_name %}
                                        <br><small>{{ line.consignor_contact_name }}</small>
                                    {% endif %}
                                    {% if line.consignor_city %}
                                        <br><small>{{ line.consignor_city }}, {{ line.consignor_country or '' }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-secondary">{{ line.shipper_account or 'N/A' }}</span>
                                </td>
                                <td>
                                    <small>{{ line.shipper_reference or 'N/A' }}</small>
                                </td>
                                <td>
                                    <span class="badge bg-primary">{{ line.origin_code or 'N/A' }}</span>
                                    <i class="fas fa-arrow-right mx-1"></i>
                                    <span class="badge bg-success">{{ line.dest_code or 'N/A' }}</span>
                                </td>
                                <td>
                                    {{ "%.2f"|format(line.billed_weight_kg or 0) }}
                                </td>
                                <td>
                                    {{ line.pieces or 0 }}
                                </td>
                                <td>
                                    <strong>{{ "%.2f"|format(line.bcu_total or 0) }}</strong>
                                    <br><small class="text-muted">{{ line.billing_currency or 'BCU' }}</small>
                                </td>
                                <td>
                                    <strong class="amount-highlight">{{ "%.2f"|format(line.lcu_total or 0) }}</strong>
                                    <br><small class="text-muted">{{ line.local_currency or 'CNY' }}</small>
                                </td>
                                <td>
                                    <small>{{ line.shipment_date or 'N/A' }}</small>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr class="table-info">
                                <th colspan="8">Invoice Total</th>
                                <th><strong>{{ "%.2f"|format(invoice_header.total_bcu) }}</strong></th>
                                <th class="amount-highlight"><strong>{{ "%.2f"|format(invoice_header.total_lcu) }} {{ first_line.local_currency or 'CNY' }}</strong></th>
                                <th></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- Charge Breakdown Summary -->
        <div class="row mt-4">
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <h4 class="text-primary">{{ "%.2f"|format(invoice_lines|sum(attribute='lcu_weight_charge') or 0) }}</h4>
                        <p class="text-muted mb-0">Total Weight Charges</p>
                        <small>{{ first_line.local_currency or 'CNY' }}</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <h4 class="text-warning">{{ "%.2f"|format(invoice_lines|sum(attribute='lcu_fuel_surcharges') or 0) }}</h4>
                        <p class="text-muted mb-0">Total Fuel Surcharges</p>
                        <small>{{ first_line.local_currency or 'CNY' }}</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <h4 class="text-info">{{ "%.2f"|format(invoice_lines|sum(attribute='lcu_other_charges') or 0) }}</h4>
                        <p class="text-muted mb-0">Total Other Charges</p>
                        <small>{{ first_line.local_currency or 'CNY' }}</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Charge Breakdown (Expandable) -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <button class="btn btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#chargeBreakdown" aria-expanded="false" aria-controls="chargeBreakdown">
                        <i class="fas fa-chart-bar"></i> Detailed Charge Breakdown
                    </button>
                </h5>
            </div>
            <div id="chargeBreakdown" class="collapse">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>AWB</th>
                                    <th>Weight Charge</th>
                                    <th>Fuel Surcharge</th>
                                    <th>Other Charges</th>
                                    <th>Discount</th>
                                    <th>Duties/Taxes</th>
                                    <th>Taxes Applicable</th>
                                    <th>LCU Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for line in invoice_lines %}
                                <tr>
                                    <td><strong>{{ line.air_waybill }}</strong></td>
                                    <td>{{ "%.2f"|format(line.lcu_weight_charge or 0) }}</td>
                                    <td>{{ "%.2f"|format(line.lcu_fuel_surcharges or 0) }}</td>
                                    <td>{{ "%.2f"|format(line.lcu_other_charges or 0) }}</td>
                                    <td class="text-success">{{ "%.2f"|format(line.lcu_discount or 0) }}</td>
                                    <td>{{ "%.2f"|format(line.lcu_duties_taxes or 0) }}</td>
                                    <td>{{ "%.2f"|format(line.lcu_taxes_applicable or 0) }}</td>
                                    <td><strong>{{ "%.2f"|format(line.lcu_total or 0) }}</strong></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr class="table-warning">
                                    <th>Totals</th>
                                    <th>{{ "%.2f"|format(invoice_lines|sum(attribute='lcu_weight_charge') or 0) }}</th>
                                    <th>{{ "%.2f"|format(invoice_lines|sum(attribute='lcu_fuel_surcharges') or 0) }}</th>
                                    <th>{{ "%.2f"|format(invoice_lines|sum(attribute='lcu_other_charges') or 0) }}</th>
                                    <th class="text-success">{{ "%.2f"|format(invoice_lines|sum(attribute='lcu_discount') or 0) }}</th>
                                    <th>{{ "%.2f"|format(invoice_lines|sum(attribute='lcu_duties_taxes') or 0) }}</th>
                                    <th>{{ "%.2f"|format(invoice_lines|sum(attribute='lcu_taxes_applicable') or 0) }}</th>
                                    <th><strong>{{ "%.2f"|format(invoice_lines|sum(attribute='lcu_total') or 0) }} {{ first_line.local_currency or 'CNY' }}</strong></th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Shipper Analysis Summary -->
        <div class="card mt-4">
            <div class="card-header">
                <h5><i class="fas fa-users"></i> Shipper Analysis</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% set shipper_groups = {} %}
                    {% for line in invoice_lines %}
                        {% set shipper = line.consignor_name or 'Unknown' %}
                        {% if shipper not in shipper_groups %}
                            {% set _ = shipper_groups.update({shipper: {'count': 0, 'total': 0, 'shipments': []}}) %}
                        {% endif %}
                        {% set _ = shipper_groups[shipper]['shipments'].append(line) %}
                        {% set _ = shipper_groups[shipper].update({'count': shipper_groups[shipper]['count'] + 1}) %}
                        {% set _ = shipper_groups[shipper].update({'total': shipper_groups[shipper]['total'] + (line.lcu_total or 0)}) %}
                    {% endfor %}
                    
                    {% for shipper, data in shipper_groups.items() %}
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-title">{{ shipper }}</h6>
                                <p class="card-text">
                                    <span class="badge bg-primary">{{ data.count }} shipments</span><br>
                                    <strong>{{ "%.2f"|format(data.total) }} {{ first_line.local_currency or 'CNY' }}</strong>
                                </p>
                                <small class="text-muted">
                                    AWBs: 
                                    {% for shipment in data.shipments %}
                                        {{ shipment.air_waybill }}{% if not loop.last %}, {% endif %}
                                    {% endfor %}
                                </small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

    {% else %}
        <!-- AU Invoice Details (Legacy) -->
        <div class="row">
            <div class="col-md-6">
                <div class="detail-section">
                    <h5><i class="fas fa-shipping-fast"></i> Shipper Details</h5>
                    <div class="address-block">
                        <strong>{{ invoice_header.shipper.company or 'N/A' }}</strong><br>
                        {{ invoice_header.shipper.address1 or '' }}<br>
                        {% if invoice_header.shipper.address2 %}{{ invoice_header.shipper.address2 }}<br>{% endif %}
                        {{ invoice_header.shipper.city or '' }}, {{ invoice_header.shipper.state or '' }} {{ invoice_header.shipper.postal_code or '' }}<br>
                        {{ invoice_header.shipper.country or '' }}
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="detail-section">
                    <h5><i class="fas fa-user"></i> Receiver Details</h5>
                    <div class="address-block">
                        <strong>{{ invoice_header.receiver.company or 'N/A' }}</strong><br>
                        {{ invoice_header.receiver.address1 or '' }}<br>
                        {% if invoice_header.receiver.address2 %}{{ invoice_header.receiver.address2 }}<br>{% endif %}
                        {{ invoice_header.receiver.city or '' }}, {{ invoice_header.receiver.state or '' }} {{ invoice_header.receiver.postal_code or '' }}<br>
                        {{ invoice_header.receiver.country or '' }}
                    </div>
                </div>
            </div>
        </div>

        <!-- AU Shipment Details Table -->
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-list"></i> Line Items ({{ invoice_lines|length }} items)</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="thead-dark">
                            <tr>
                                <th>Line</th>
                                <th>AWB</th>
                                <th>Product</th>
                                <th>Route</th>
                                <th>Weight</th>
                                <th>Amount (AUD)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for line in invoice_lines %}
                            <tr class="line-item-row">
                                <td>{{ line.line_number }}</td>
                                <td><strong>{{ line.awb_number or 'N/A' }}</strong></td>
                                <td>{{ line.product_description or 'N/A' }}</td>
                                <td>{{ line.origin_code or '' }} → {{ line.destination_code or '' }}</td>
                                <td>{{ line.weight or 'N/A' }}</td>
                                <td><strong class="amount-highlight">${{ "%.2f"|format(line.amount or 0) }}</strong></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr class="table-info">
                                <th colspan="5">Total Amount</th>
                                <th class="amount-highlight">${{ "%.2f"|format(invoice_lines|sum(attribute='amount')) }} AUD</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- Action Buttons -->
    <div class="mt-4 text-center">
        <a href="/dhl-express/invoices" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Invoices
        </a>
        {% if has_invoice_image %}
            <a href="/invoice-images/view/{{ invoice_header.invoice_no }}/DHL_EXPRESS" class="btn btn-info ml-2">
                <i class="fas fa-image"></i> View Invoice Image
            </a>
        {% endif %}
        <a href="/dhl-express/audit/{{ invoice_header.invoice_no }}" class="btn btn-dhl ml-2">
            <i class="fas fa-search"></i> Run Audit
        </a>
    </div>
</div>

{% endblock %}
