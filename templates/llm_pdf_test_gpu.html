{% extends "base.html" %}

{% block title %}LLM GPU & Model Testing{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">
                <i class="fas fa-microchip text-warning"></i>
                LLM GPU & Model Testing
            </h1>
            
            <!-- Back to Dashboard -->
            <div class="mb-3">
                <a href="{{ url_for('llm_pdf.dashboard') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
            </div>
            
            <!-- GPU Status -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-microchip"></i> GPU Status</h5>
                        </div>
                        <div class="card-body">
                            <div id="gpu-status-info">
                                <i class="fas fa-spinner fa-spin"></i> Checking GPU availability...
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-brain"></i> Model Status</h5>
                        </div>
                        <div class="card-body">
                            <div id="model-status-info">
                                <i class="fas fa-spinner fa-spin"></i> Checking DeepSeek-R1...
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-stopwatch"></i> Performance</h5>
                        </div>
                        <div class="card-body">
                            <div id="performance-info">
                                <span class="text-muted">Run test to see results</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Test Controls -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-play"></i> Performance Tests</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <button class="btn btn-success btn-lg w-100 mb-3" onclick="runQuickTest()">
                                        <i class="fas fa-bolt"></i>
                                        Quick Test (30s)
                                    </button>
                                    <small class="text-muted">Basic GPU utilization test</small>
                                </div>
                                
                                <div class="col-md-4">
                                    <button class="btn btn-warning btn-lg w-100 mb-3" onclick="runIntensiveTest()">
                                        <i class="fas fa-fire"></i>
                                        Intensive Test (60s)
                                    </button>
                                    <small class="text-muted">Heavy GPU stress test</small>
                                </div>
                                
                                <div class="col-md-4">
                                    <button class="btn btn-info btn-lg w-100 mb-3" onclick="runBenchmark()">
                                        <i class="fas fa-chart-line"></i>
                                        Benchmark (90s)
                                    </button>
                                    <small class="text-muted">Complete performance benchmark</small>
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <div class="alert alert-info" role="alert">
                                    <i class="fas fa-info-circle"></i>
                                    <strong>Monitor GPU Usage:</strong> Open Task Manager → Performance → GPU to watch real-time utilization during tests
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Test Progress -->
            <div id="test-progress-section" class="mb-4" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-cog fa-spin"></i> Running Performance Test...</h5>
                    </div>
                    <div class="card-body">
                        <div class="progress mb-3">
                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-warning" 
                                 role="progressbar" style="width: 0%" id="test-progress-bar"></div>
                        </div>
                        <div id="test-status">Initializing test...</div>
                        <div class="mt-2">
                            <small class="text-muted" id="test-details">Test details will appear here</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Test Results -->
            <div id="test-results-section" class="mb-4" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-bar"></i> Test Results</h5>
                    </div>
                    <div class="card-body" id="test-results-content">
                        <!-- Results will be populated here -->
                    </div>
                </div>
            </div>
            
            <!-- Test Instructions -->
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-question-circle"></i> How to Monitor GPU</h5>
                        </div>
                        <div class="card-body">
                            <ol>
                                <li>Open <strong>Task Manager</strong> (Ctrl+Shift+Esc)</li>
                                <li>Click on the <strong>Performance</strong> tab</li>
                                <li>Select <strong>GPU</strong> from the left sidebar</li>
                                <li>Watch the <strong>GPU utilization</strong> graph</li>
                                <li>Look for <strong>CUDA</strong> or <strong>Compute</strong> usage spikes</li>
                            </ol>
                            <div class="alert alert-warning mt-3" role="alert">
                                <small><i class="fas fa-exclamation-triangle"></i> 
                                GPU utilization should spike during LLM processing if GPU acceleration is working</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-cogs"></i> System Requirements</h5>
                        </div>
                        <div class="card-body">
                            <h6>For GPU Acceleration:</h6>
                            <ul>
                                <li><i class="fas fa-check text-success"></i> NVIDIA GPU with 4GB+ VRAM</li>
                                <li><i class="fas fa-check text-success"></i> CUDA 11.8+ drivers</li>
                                <li><i class="fas fa-check text-success"></i> Ollama with GPU support</li>
                                <li><i class="fas fa-check text-success"></i> DeepSeek-R1 model loaded</li>
                            </ul>
                            
                            <h6 class="mt-3">Your System:</h6>
                            <div id="system-info">
                                <i class="fas fa-spinner fa-spin"></i> Detecting system...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Model Testing Section -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="fas fa-brain"></i> Test Model with Custom Prompt</h5>
                        </div>
                        <div class="card-body">
                            <form id="test-model-form">
                                <div class="mb-3">
                                    <label for="prompt" class="form-label">Enter prompt for DeepSeek-R1 model</label>
                                    <textarea class="form-control" id="prompt" rows="4" placeholder="Enter your prompt here..."></textarea>
                                </div>
                                
                                <button type="submit" class="btn btn-primary" id="submit-prompt">
                                    <i class="fas fa-paper-plane"></i> Submit Prompt
                                </button>
                            </form>
                            
                            <!-- Results Card -->
                            <div class="card mt-4 d-none" id="results-card">
                                <div class="card-header bg-light">
                                    <h5 class="mb-0"><i class="fas fa-reply"></i> Model Response</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">Processing Time</label>
                                        <div id="processing-time" class="bg-light p-2 rounded">-</div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Response</label>
                                        <div id="model-response" class="bg-light p-3 rounded" style="white-space: pre-wrap; max-height: 500px; overflow-y: auto;">
                                            Response will appear here...
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Check system status on page load
document.addEventListener('DOMContentLoaded', function() {
    checkSystemStatus();
});

function checkSystemStatus() {
    // Check GPU status
    fetch('/llm-pdf/api/gpu-status')
        .then(response => response.json())
        .then(data => {
            const gpuStatusDiv = document.getElementById('gpu-status-info');
            if (data.available) {
                gpuStatusDiv.innerHTML = `
                    <i class="fas fa-check-circle text-success"></i> GPU Available<br>
                    <small class="text-muted">${data.details || 'Ready for acceleration'}</small>
                `;
            } else {
                gpuStatusDiv.innerHTML = `
                    <i class="fas fa-exclamation-triangle text-warning"></i> CPU Only<br>
                    <small class="text-muted">GPU acceleration not available</small>
                `;
            }
        })
        .catch(error => {
            document.getElementById('gpu-status-info').innerHTML = 
                '<i class="fas fa-times-circle text-danger"></i> Status Unknown';
        });
    
    // Check model status
    fetch('/llm-pdf/api/model-status')
        .then(response => response.json())
        .then(data => {
            const modelStatusDiv = document.getElementById('model-status-info');
            if (data.available) {
                modelStatusDiv.innerHTML = `
                    <i class="fas fa-check-circle text-success"></i> DeepSeek-R1 Ready<br>
                    <small class="text-muted">Model loaded and available</small>
                `;
            } else {
                modelStatusDiv.innerHTML = `
                    <i class="fas fa-times-circle text-danger"></i> Model Unavailable<br>
                    <small class="text-muted">Please start Ollama with DeepSeek-R1</small>
                `;
            }
        })
        .catch(error => {
            document.getElementById('model-status-info').innerHTML = 
                '<i class="fas fa-times-circle text-danger"></i> Status Unknown';
        });
}

function runQuickTest() {
    runTest('quick', 30);
}

function runIntensiveTest() {
    runTest('intensive', 60);
}

function runBenchmark() {
    runTest('benchmark', 90);
}

function runTest(testType, duration) {
    // Show progress section
    document.getElementById('test-progress-section').style.display = 'block';
    document.getElementById('test-results-section').style.display = 'none';
    
    const progressBar = document.getElementById('test-progress-bar');
    const statusDiv = document.getElementById('test-status');
    const detailsDiv = document.getElementById('test-details');
    
    statusDiv.textContent = `Running ${testType} test...`;
    detailsDiv.textContent = `Duration: ${duration} seconds | Monitor GPU usage in Task Manager`;
    
    // Disable test buttons
    const buttons = document.querySelectorAll('button[onclick^="run"]');
    buttons.forEach(btn => btn.disabled = true);
    
    let progress = 0;
    const startTime = Date.now();
    
    // Simulate progress
    const progressInterval = setInterval(() => {
        const elapsed = (Date.now() - startTime) / 1000;
        progress = Math.min((elapsed / duration) * 100, 95);
        progressBar.style.width = progress + '%';
        
        if (progress < 30) {
            statusDiv.textContent = 'Initializing LLM processing...';
        } else if (progress < 60) {
            statusDiv.textContent = 'Running GPU-intensive operations...';
        } else {
            statusDiv.textContent = 'Completing test and collecting metrics...';
        }
    }, 500);
    
    // Make the actual test request
    fetch(`/llm-pdf/api/test-gpu/${testType}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        clearInterval(progressInterval);
        progressBar.style.width = '100%';
        statusDiv.textContent = 'Test completed!';
        
        // Re-enable buttons
        buttons.forEach(btn => btn.disabled = false);
        
        showTestResults(data);
    })
    .catch(error => {
        clearInterval(progressInterval);
        buttons.forEach(btn => btn.disabled = false);
        showTestError(error.message);
    });
}

function showTestResults(data) {
    document.getElementById('test-progress-section').style.display = 'none';
    document.getElementById('test-results-section').style.display = 'block';
    
    const resultsContent = document.getElementById('test-results-content');
    const performanceInfo = document.getElementById('performance-info');
    
    // Update performance card
    if (data.success) {
        performanceInfo.innerHTML = `
            <strong>Avg Response Time:</strong> ${data.avg_response_time?.toFixed(2) || 'N/A'}s<br>
            <strong>Throughput:</strong> ${data.throughput?.toFixed(1) || 'N/A'} req/min
        `;
    }
    
    let html = '';
    
    if (data.success) {
        html = `
            <div class="alert alert-success" role="alert">
                <i class="fas fa-check-circle"></i> Test completed successfully!
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <h6><i class="fas fa-stopwatch"></i> Performance Metrics</h6>
                    <table class="table table-sm">
                        <tr><td><strong>Total Requests:</strong></td><td>${data.total_requests || 0}</td></tr>
                        <tr><td><strong>Successful Requests:</strong></td><td>${data.successful_requests || 0}</td></tr>
                        <tr><td><strong>Average Response Time:</strong></td><td>${data.avg_response_time?.toFixed(2) || 'N/A'}s</td></tr>
                        <tr><td><strong>Min Response Time:</strong></td><td>${data.min_response_time?.toFixed(2) || 'N/A'}s</td></tr>
                        <tr><td><strong>Max Response Time:</strong></td><td>${data.max_response_time?.toFixed(2) || 'N/A'}s</td></tr>
                        <tr><td><strong>Throughput:</strong></td><td>${data.throughput?.toFixed(1) || 'N/A'} requests/minute</td></tr>
                    </table>
                </div>
                
                <div class="col-md-6">
                    <h6><i class="fas fa-microchip"></i> System Performance</h6>
                    <table class="table table-sm">
                        <tr><td><strong>Test Duration:</strong></td><td>${data.test_duration?.toFixed(2) || 'N/A'}s</td></tr>
                        <tr><td><strong>Model Used:</strong></td><td>${data.model_used || 'N/A'}</td></tr>
                        <tr><td><strong>GPU Acceleration:</strong></td><td>${data.gpu_used ? '<i class="fas fa-check text-success"></i> Yes' : '<i class="fas fa-times text-warning"></i> No'}</td></tr>
                        <tr><td><strong>Error Rate:</strong></td><td>${data.error_rate?.toFixed(1) || '0'}%</td></tr>
                    </table>
                </div>
            </div>
            
            <div class="mt-3">
                <h6><i class="fas fa-chart-line"></i> Performance Analysis</h6>
                <div class="card bg-light">
                    <div class="card-body">
                        ${generatePerformanceAnalysis(data)}
                    </div>
                </div>
            </div>
        `;
    } else {
        html = `
            <div class="alert alert-danger" role="alert">
                <i class="fas fa-exclamation-triangle"></i> Test failed: ${data.error || 'Unknown error'}
            </div>
            
            <div class="mt-3">
                <h6>Troubleshooting Tips:</h6>
                <ul>
                    <li>Ensure Ollama is running: <code>ollama serve</code></li>
                    <li>Check if DeepSeek-R1 is installed: <code>ollama list</code></li>
                    <li>Install the model: <code>ollama pull deepseek-r1:latest</code></li>
                    <li>Verify GPU drivers are up to date</li>
                </ul>
            </div>
        `;
    }
    
    html += `
        <div class="mt-3">
            <button class="btn btn-primary" onclick="checkSystemStatus()">
                <i class="fas fa-sync"></i> Refresh System Status
            </button>
            <button class="btn btn-success" onclick="window.location.reload()">
                <i class="fas fa-redo"></i> Run Another Test
            </button>
        </div>
    `;
    
    resultsContent.innerHTML = html;
}

function generatePerformanceAnalysis(data) {
    let analysis = '';
    
    if (data.avg_response_time < 5) {
        analysis += '<i class="fas fa-check-circle text-success"></i> <strong>Excellent:</strong> Very fast response times indicate good GPU acceleration.<br>';
    } else if (data.avg_response_time < 15) {
        analysis += '<i class="fas fa-exclamation-triangle text-warning"></i> <strong>Good:</strong> Reasonable response times, GPU may be partially utilized.<br>';
    } else {
        analysis += '<i class="fas fa-times-circle text-danger"></i> <strong>Slow:</strong> High response times suggest CPU-only processing.<br>';
    }
}

// Model Testing Functions
document.addEventListener('DOMContentLoaded', function() {
    // Add event listener for model testing form
    document.getElementById('test-model-form').addEventListener('submit', function(e) {
        e.preventDefault();
        testModel();
    });
});

function testModel() {
    const promptText = document.getElementById('prompt').value.trim();
    if (!promptText) {
        alert('Please enter a prompt');
        return;
    }
    
    console.log("Submitting prompt:", promptText);
    
    // Show loading
    const submitButton = document.getElementById('submit-prompt');
    const originalButtonText = submitButton.innerHTML;
    submitButton.disabled = true;
    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
    
    // Prepare data
    const formData = new FormData();
    formData.append('prompt', promptText);
    console.log("Form data created with prompt");
    
    // Send request
    const startTime = new Date();
    console.log("Starting API request to /llm-pdf/api/test-model");
    
    fetch('/llm-pdf/api/test-model', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}, Text: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        const endTime = new Date();
        const processingTime = (endTime - startTime) / 1000; // seconds
        
        // Show results card
        document.getElementById('results-card').classList.remove('d-none');
        
        // Update processing time
        document.getElementById('processing-time').textContent = `${processingTime.toFixed(2)} seconds`;
        
        // Update response
        if (data.success) {
            document.getElementById('model-response').textContent = data.response;
        } else {
            document.getElementById('model-response').innerHTML = 
                `<div class="text-danger"><i class="fas fa-exclamation-triangle"></i> Error: ${data.error}</div>`;
        }
    })
    .catch(error => {
        console.error("Error in model test:", error);
        // Show error
        document.getElementById('results-card').classList.remove('d-none');
        document.getElementById('model-response').innerHTML = 
            `<div class="text-danger">
                <i class="fas fa-exclamation-triangle"></i> 
                <strong>Request Error:</strong> ${error.toString()}
                <p class="mt-2">This may indicate that Ollama is not running. Please make sure Ollama is running with the DeepSeek-R1 model loaded.</p>
            </div>`;
    })
    .finally(() => {
        // Restore button
        submitButton.disabled = false;
        submitButton.innerHTML = originalButtonText;
    });
    
    if (data.throughput > 5) {
        analysis += '<i class="fas fa-check-circle text-success"></i> <strong>High Throughput:</strong> System can handle multiple concurrent requests efficiently.<br>';
    } else if (data.throughput > 2) {
        analysis += '<i class="fas fa-exclamation-triangle text-warning"></i> <strong>Moderate Throughput:</strong> Decent performance for most use cases.<br>';
    } else {
        analysis += '<i class="fas fa-times-circle text-warning"></i> <strong>Low Throughput:</strong> Consider optimizing GPU settings or hardware.<br>';
    }
    
    if (data.error_rate === 0) {
        analysis += '<i class="fas fa-check-circle text-success"></i> <strong>Perfect Reliability:</strong> No errors during testing.';
    } else if (data.error_rate < 10) {
        analysis += '<i class="fas fa-exclamation-triangle text-warning"></i> <strong>Minor Issues:</strong> Low error rate, system is mostly stable.';
    } else {
        analysis += '<i class="fas fa-times-circle text-danger"></i> <strong>High Error Rate:</strong> System may be unstable or overloaded.';
    }
    
    return analysis;
}

function showTestError(errorMessage) {
    document.getElementById('test-progress-section').style.display = 'none';
    document.getElementById('test-results-section').style.display = 'block';
    
    const resultsContent = document.getElementById('test-results-content');
    resultsContent.innerHTML = `
        <div class="alert alert-danger" role="alert">
            <i class="fas fa-exclamation-triangle"></i> Test Error: ${errorMessage}
        </div>
        <div class="mt-3">
            <button class="btn btn-warning" onclick="checkSystemStatus()">
                <i class="fas fa-sync"></i> Check System Status
            </button>
            <button class="btn btn-secondary" onclick="window.location.reload()">
                <i class="fas fa-refresh"></i> Try Again
            </button>
        </div>
    `;
}
</script>
{% endblock %}
