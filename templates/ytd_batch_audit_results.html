{% extends "base.html" %}

{% block title %}Batch Audit Results - {{ batch_info.run_name }}{% endblock %}

{% block content %}
<d                                                <option value="APPROVED" {% if status_filter == 'APPROVED' %}selected{% endif %}>Approved</option>
                                                <option value="REVIEW_REQUIRED" {% if status_filter == 'REVIEW_REQUIRED' %}selected{% endif %}>Review Required</option>
                                                <option value="REJECTED" {% if status_filter == 'REJECTED' %}selected{% endif %}>No Rate Card</option>class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1>
                    <i class="fas fa-chart-bar text-primary"></i>
                    Batch Audit Results
                </h1>
                <a href="{{ url_for('ytd_batch_audit.ytd_batch_audit_dashboard') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
            </div>
            

            <!-- Batch Info Card -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-info-circle"></i> Batch Information</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Batch ID:</strong> {{ batch_info.id }}</p>
                                    <p><strong>Description:</strong> {{ batch_info.run_name }}</p>
                                    <p><strong>Status:</strong> 
                                        <span class="badge 
                                            {% if batch_info.status == 'completed' %}bg-success
                                            {% elif batch_info.status == 'running' %}bg-warning
                                            {% else %}bg-danger{% endif %}">
                                            {{ batch_info.status.title() }}
                                        </span>
                                    </p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Total Invoices:</strong> {{ batch_info.total_invoices }}</p>
                                    <p><strong>Processing Time:</strong> {{ "%.2f"|format(batch_info.processing_time_ms / 1000) }}s</p>
                                    <p><strong>Created:</strong> {{ batch_info.created_at }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Summary Cards -->
            <div class="row mb-4">
                <div class="col-lg-3 col-md-6 col-sm-6 mb-3">
                    <div class="card bg-info text-white">
                        <div class="card-body text-center">
                            <h3>{{ batch_info.invoices_warned }}</h3>
                            <p class="mb-0">Review Required<br><small>(Acceptable)</small></p>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-3 col-md-6 col-sm-6 mb-3">
                    <div class="card bg-danger text-white">
                        <div class="card-body text-center">
                            <h3 id="rejectedCount">{{ status_counts.rejected if status_counts else 0 }}</h3>
                            <p class="mb-0">Rejected<br><small>(High Variance)</small></p>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-3 col-md-6 col-sm-6 mb-3">
                    <div class="card bg-dark text-white">
                        <div class="card-body text-center">
                            <h3 id="noRateCardCount">{{ status_counts.no_rate_card if status_counts else 0 }}</h3>
                            <p class="mb-0">No Rate Card<br><small>(Missing Rates)</small></p>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-3 col-md-6 col-sm-6 mb-3">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <h3>{{ batch_info.invoices_passed }}</h3>
                            <p class="mb-0">Approved<br><small>(Perfect Match)</small></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Table -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5><i class="fas fa-table"></i> Audit Results ({{ results|length }} invoices)</h5>
                            <div>
                                <button class="btn btn-sm btn-outline-primary" onclick="exportResults()">
                                    <i class="fas fa-download"></i> Export CSV
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Filter Controls -->
                            <div class="row mb-3">
                                <!-- Invoice Number Search -->
                                <div class="col-md-4">
                                    <form class="form-inline" method="get" action="{{ url_for('ytd_batch_audit.ytd_batch_audit_results', batch_id=batch_info.id) }}">
                                        <input type="hidden" name="status" value="{{ status_filter or 'all' }}">
                                        <input type="hidden" name="per_page" value="{{ pagination.per_page }}">
                                        <div class="input-group">
                                            <input type="text" class="form-control" name="invoices" 
                                                   value="{{ invoice_filter or '' }}" 
                                                   placeholder="Invoice numbers (comma-separated)"
                                                   title="Enter invoice numbers separated by commas, e.g. D123456, D789012">
                                            <button class="btn btn-outline-primary" type="submit">
                                                <i class="fas fa-search"></i> Search
                                            </button>
                                        </div>
                                        <small class="form-text text-muted">Enter invoice numbers separated by commas</small>
                                    </form>
                                </div>
                                
                                <!-- Status Filter -->
                                <div class="col-md-3">
                                    <form class="form-inline" method="get" action="{{ url_for('ytd_batch_audit.ytd_batch_audit_results', batch_id=batch_info.id) }}">
                                        <input type="hidden" name="invoices" value="{{ invoice_filter or '' }}">
                                        <input type="hidden" name="per_page" value="{{ pagination.per_page }}">
                                        <div class="input-group">
                                            <label class="input-group-text" for="statusFilter">Status:</label>
                                            <select class="form-select" id="statusFilter" name="status" onchange="this.form.submit()">
                                                <option value="all" {% if not status_filter or status_filter == 'all' %}selected{% endif %}>All</option>
                                                <option value="approved" {% if status_filter == 'approved' %}selected{% endif %}>Approved</option>
                                                <option value="rejected" {% if status_filter == 'rejected' %}selected{% endif %}>Rejected</option>
                                                <option value="No Rate Card" {% if status_filter == 'No Rate Card' %}selected{% endif %}>No Rate Card</option>
                                            </select>
                                        </div>
                                    </form>
                                </div>
                                
                                <!-- Page Size Selector -->
                                <div class="col-md-3">
                                    <form class="form-inline" method="get" action="{{ url_for('ytd_batch_audit.ytd_batch_audit_results', batch_id=batch_info.id) }}">
                                        <input type="hidden" name="status" value="{{ status_filter or 'all' }}">
                                        <input type="hidden" name="invoices" value="{{ invoice_filter or '' }}">
                                        <div class="input-group">
                                            <label class="input-group-text" for="pageSizeFilter">Show:</label>
                                            <select class="form-select" id="pageSizeFilter" name="per_page" onchange="this.form.submit()">
                                                <option value="20" {% if pagination.per_page == 20 %}selected{% endif %}>20</option>
                                                <option value="50" {% if pagination.per_page == 50 %}selected{% endif %}>50</option>
                                                <option value="100" {% if pagination.per_page == 100 %}selected{% endif %}>100</option>
                                                <option value="200" {% if pagination.per_page == 200 %}selected{% endif %}>200</option>
                                            </select>
                                        </div>
                                    </form>
                                </div>
                                
                                <!-- Results Info -->
                                <div class="col-md-2 text-end">
                                    <p class="mb-0">Showing {{ results|length }} of {{ pagination.total_results }} results</p>
                                    {% if invoice_filter %}
                                        <small class="text-muted">Filtered by invoices: {{ invoice_filter }}</small>
                                    {% endif %}
                                    <!-- Clear Filters -->
                                    {% if invoice_filter or (status_filter and status_filter != 'all') %}
                                    <div class="mt-2">
                                        <a href="{{ url_for('ytd_batch_audit.ytd_batch_audit_results', batch_id=batch_info.id, per_page=pagination.per_page) }}" 
                                           class="btn btn-sm btn-outline-secondary">
                                            <i class="fas fa-times"></i> Clear Filters
                                        </a>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Loading indicator -->
                            <div id="loadingIndicator" class="text-center py-5" style="display: none;">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Loading results...</p>
                            </div>
                            
                            {% if results %}
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover" id="resultsTable">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>Invoice No</th>
                                                <th>Status</th>
                                                <th>Mode</th>
                                                <th>Invoice Amount</th>
                                                <th>Expected Amount</th>
                                                <th>Variance</th>
                                                <th>Variance %</th>
                                                <th>Rate Cards</th>
                                                <th>Lanes</th>
                                                <th>Time (ms)</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for result in results %}
                                            <tr class="
                                                {% if result.status == 'REJECTED' or result.status == 'rejected' or result.status == 'fail' or result.status == 'FAIL' %}table-danger
                                                {% elif result.status == 'REVIEW_REQUIRED' or result.status == 'review_required' %}table-info
                                                {% elif result.status == 'APPROVED' or result.status == 'approved' or result.status == 'pass' %}table-success{% endif %}">
                                                <td>
                                                    <a href="{{ url_for('ytd_batch_audit.ytd_batch_audit_invoice_detail', invoice_no=result.invoice_no) }}" 
                                                       class="text-decoration-none">
                                                        {{ result.invoice_no }}
                                                    </a>
                                                </td>
                                                <td>
                                                    <span class="badge 
                                                        {% if result.status == 'rejected' or result.status == 'REJECTED' %}bg-danger
                                                        {% elif result.status == 'fail' or result.status == 'FAIL' %}bg-danger
                                                        {% elif result.status == 'REVIEW_REQUIRED' or result.status == 'review_required' %}bg-info
                                                        {% elif result.status == 'APPROVED' or result.status == 'approved' or result.status == 'pass' %}bg-success
                                                        {% else %}bg-secondary{% endif %}">
                                                        {% if result.status == 'rejected' or result.status == 'REJECTED' %}REJECTED
                                                        {% elif result.status == 'fail' or result.status == 'FAIL' %}NO RATE CARD
                                                        {% elif result.status == 'REVIEW_REQUIRED' or result.status == 'review_required' %}REVIEW REQUIRED
                                                        {% else %}{{ result.status.upper() }}{% endif %}
                                                    </span>
                                                </td>
                                                <td>{{ result.transportation_mode or 'N/A' }}</td>
                                                <td>${{ "{:,.2f}".format(result.total_invoice_amount) }}</td>
                                                <td>${{ "{:,.2f}".format(result.total_expected_amount) }}</td>
                                                <td class="
                                                    {% if result.total_variance > 0 %}text-danger
                                                    {% elif result.total_variance < 0 %}text-success
                                                    {% else %}text-muted{% endif %}">
                                                    {% if result.total_variance > 0 %}+{% endif %}${{ "{:,.2f}".format(result.total_variance) }}
                                                </td>
                                                <td class="
                                                    {% if result.variance_percent|abs > 20 %}text-danger
                                                    {% elif result.variance_percent|abs > 10 %}text-warning
                                                    {% else %}text-muted{% endif %}">
                                                    {% if result.variance_percent > 0 %}+{% endif %}{{ "{:.2f}".format(result.variance_percent) }}%
                                                </td>
                                                <td>{{ result.rate_cards_checked }}</td>
                                                <td>{{ result.matching_lanes }}</td>
                                                <td>{{ result.processing_time_ms }}</td>
                                                <td>
                                                    <a href="{{ url_for('ytd_batch_audit.ytd_batch_audit_invoice_detail', invoice_no=result.invoice_no) }}" 
                                                       class="btn btn-sm btn-outline-primary" title="View Details">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- Pagination -->
                                {% if pagination and pagination.total_pages > 1 %}
                                <nav aria-label="Results pagination" class="mt-3">
                                    <ul class="pagination justify-content-center">
                                        <!-- Previous page -->
                                        <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                                            <a class="page-link" href="{{ url_for('ytd_batch_audit.ytd_batch_audit_results', batch_id=batch_info.id, page=pagination.page-1, status=status_filter, invoices=invoice_filter, per_page=pagination.per_page) }}" aria-label="Previous">
                                                <span aria-hidden="true">&laquo;</span>
                                            </a>
                                        </li>
                                        
                                        <!-- Page numbers -->
                                        {% for p in range(1, pagination.total_pages + 1) %}
                                            {% if p == pagination.page %}
                                                <li class="page-item active"><span class="page-link">{{ p }}</span></li>
                                            {% elif p == 1 or p == pagination.total_pages or (p >= pagination.page - 2 and p <= pagination.page + 2) %}
                                                <li class="page-item">
                                                    <a class="page-link" href="{{ url_for('ytd_batch_audit.ytd_batch_audit_results', batch_id=batch_info.id, page=p, status=status_filter, invoices=invoice_filter, per_page=pagination.per_page) }}">{{ p }}</a>
                                                </li>
                                            {% elif p == pagination.page - 3 or p == pagination.page + 3 %}
                                                <li class="page-item disabled"><span class="page-link">...</span></li>
                                            {% endif %}
                                        {% endfor %}
                                        
                                        <!-- Next page -->
                                        <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                                            <a class="page-link" href="{{ url_for('ytd_batch_audit.ytd_batch_audit_results', batch_id=batch_info.id, page=pagination.page+1, status=status_filter, invoices=invoice_filter, per_page=pagination.per_page) }}" aria-label="Next">
                                                <span aria-hidden="true">&raquo;</span>
                                            </a>
                                        </li>
                                    </ul>
                                </nav>
                                {% endif %}
                                
                            {% else %}
                                <div class="text-center py-4">
                                    <i class="fas fa-info-circle fa-3x text-muted mb-3"></i>
                                    <h5 class="text-muted">No results found</h5>
                                    <p class="text-muted">
                                        {% if status_filter and status_filter != 'all' %}
                                            No results with status "{{ status_filter }}" found. 
                                            <a href="{{ url_for('ytd_batch_audit.ytd_batch_audit_results', batch_id=batch_info.id) }}">
                                                Clear filter
                                            </a>
                                        {% else %}
                                            This batch audit run has no results. Try running 
                                            <a href="{{ url_for('ytd_batch_audit.ytd_batch_audit_dashboard') }}">
                                                another batch audit
                                            </a>.
                                        {% endif %}
                                    </p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Initialize DataTable if available
$(document).ready(function() {
    // Hide loading indicator when page is ready
    $('#loadingIndicator').hide();
    
    if ($.fn.DataTable) {
        $('#resultsTable').DataTable({
            "pageLength": 25,
            "order": [[ 5, "desc" ]],  // Order by variance descending
            "columnDefs": [
                { "orderable": false, "targets": 10 }  // Actions column not sortable
            ],
            "language": {
                "search": "Filter invoices:",
                "lengthMenu": "Show _MENU_ invoices per page",
                "info": "Showing _START_ to _END_ of _TOTAL_ invoices"
            }
        });
    }
    
    // Show loading indicator when clicking links or submitting forms
    $('a, form').on('click submit', function() {
        // Don't show for export or actions that don't navigate
        if (!$(this).hasClass('export-btn') && !$(this).hasClass('no-loading')) {
            $('#resultsTable').hide();
            $('#loadingIndicator').show();
        }
    });
});

// Export results to CSV
function exportResults() {
    const table = document.getElementById('resultsTable');
    let csv = 'Invoice No,Status,Mode,Invoice Amount,Expected Amount,Variance,Variance %,Rate Cards,Lanes,Time (ms)\n';
    
    const rows = table.querySelectorAll('tbody tr');
    rows.forEach(row => {
        const cols = row.querySelectorAll('td');
        const rowData = [];
        for (let i = 0; i < cols.length - 1; i++) {  // Exclude actions column
            let cellText = cols[i].innerText.replace(/,/g, '');
            if (cellText.includes('"')) {
                cellText = '"' + cellText.replace(/"/g, '""') + '"';
            }
            rowData.push(cellText);
        }
        csv += rowData.join(',') + '\n';
    });
    
    // Download CSV
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'batch_audit_results_{{ batch_info.id }}_{{ batch_info.created_at[:10] }}.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}
</script>
{% endblock %}
