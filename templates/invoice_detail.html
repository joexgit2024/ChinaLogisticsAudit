{% extends "base.html" %}

{% block title %}Invoice {{ invoice['invoice_number'] or 'Detail' }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-md-8">
            <h1 class="h3">Invoice {{ invoice['invoice_number'] or 'Detail' }}</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('rate_card.air_rates') }}">Air Rates</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('invoice.invoices') }}">Invoices</a></li>
                    <li class="breadcrumb-item active">{{ invoice['invoice_number'] or 'Detail' }}</li>
                </ol>
            </nav>
        </div>
        <div class="col-md-4 text-end">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="fas fa-download me-2"></i>Download
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="{{ url_for('download.download_invoice_json', invoice_id=invoice['id']) }}">
                        <i class="fas fa-file-code me-2"></i>Complete Data (JSON)
                    </a></li>
                    <li><a class="dropdown-item" href="{{ url_for('download.download_invoice_csv', invoice_id=invoice['id']) }}">
                        <i class="fas fa-file-csv me-2"></i>Summary (CSV)
                    </a></li>
                    <li><a class="dropdown-item" href="{{ url_for('download.download_invoice_edi', invoice_id=invoice['id']) }}">
                        <i class="fas fa-file-alt me-2"></i>Original EDI File
                    </a></li>
                </ul>
            </div>
            {% if invoice.shipping_mode and 'air' in invoice.shipping_mode|lower %}
                <button id="auditButton" type="button" class="btn btn-outline-info ms-2" onclick="auditAirFreight()">
                    <i class="fas fa-search-dollar me-2"></i>Audit Air Freight
                </button>
            {% endif %}
            <a href="{{ url_for('invoice.invoices') }}" class="btn btn-outline-secondary ms-2">
                <i class="fas fa-arrow-left me-2"></i>Back to List
            </a>
        </div>
    </div>

{% if invoice %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" id="invoiceDetailTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basic" type="button" role="tab">
                            <i class="fas fa-info-circle me-2"></i>Basic Info
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="addresses-tab" data-bs-toggle="tab" data-bs-target="#addresses" type="button" role="tab">
                            <i class="fas fa-map-marker-alt me-2"></i>Addresses
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="charges-tab" data-bs-toggle="tab" data-bs-target="#charges" type="button" role="tab"{% if not charges %} style="opacity: 0.6;"{% endif %}>
                            <i class="fas fa-money-bill me-2"></i>Charges{% if charges %} ({{ charges|length }}){% endif %}
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="line-items-tab" data-bs-toggle="tab" data-bs-target="#line-items" type="button" role="tab"{% if not line_items %} style="opacity: 0.6;"{% endif %}>
                            <i class="fas fa-boxes me-2"></i>Line Items{% if line_items %} ({{ line_items|length }}){% endif %}
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="references-tab" data-bs-toggle="tab" data-bs-target="#references" type="button" role="tab">
                            <i class="fas fa-hashtag me-2"></i>References{% if reference_numbers %} (+{{ reference_numbers|length }}){% endif %}
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="shipment-tab" data-bs-toggle="tab" data-bs-target="#shipment" type="button" role="tab"{% if not shipments %} style="opacity: 0.6;"{% endif %}>
                            <i class="fas fa-shipping-fast me-2"></i>Shipment{% if shipments %} ({{ shipments|length }}){% endif %}
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="technical-tab" data-bs-toggle="tab" data-bs-target="#technical" type="button" role="tab">
                            <i class="fas fa-cogs me-2"></i>Technical
                        </button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content" id="invoiceDetailTabsContent">
                    <!-- Basic Information Tab -->
                    <div class="tab-pane fade show active" id="basic" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <h5 class="text-primary mb-3">Invoice Details</h5>
                                <table class="table table-borderless">
                                    <tr><td class="fw-bold">Invoice Number:</td><td>{{ invoice['invoice_number'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Client Code:</td><td>{{ invoice['client_code'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Carrier Code:</td><td>{{ invoice['carrier_code'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Invoice Date:</td><td>{{ invoice['invoice_date'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Invoice Status:</td><td>{{ invoice['invoice_status'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">PRO Number:</td><td>{{ invoice['pro_number'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Reference Number:</td><td>{{ invoice['reference_number'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Bill of Lading:</td><td>{{ invoice['bill_of_lading'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Booking Number:</td><td>{{ invoice['booking_number'] or 'N/A' }}</td></tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <h5 class="text-primary mb-3">Financial Summary</h5>
                                <table class="table table-borderless">
                                    <tr><td class="fw-bold">Total Charges:</td><td class="fw-bold text-success">${{ "%.2f"|format(invoice['invoice_amount'] or 0.0) }}</td></tr>
                                    <tr><td class="fw-bold">Net Charge:</td><td>${{ "%.2f"|format(invoice['net_charge'] or 0.0) }}</td></tr>
                                    <tr><td class="fw-bold">Currency:</td><td>{{ invoice['currency'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Exchange Rate:</td><td>{{ invoice['exchange_rate'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Declared Value:</td><td>${{ "%.2f"|format(invoice['declared_value'] or 0.0) }}</td></tr>
                                    <tr><td class="fw-bold">Check Number:</td><td>{{ invoice['check_number'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Check Date:</td><td>{{ invoice['check_date'] or 'N/A' }}</td></tr>
                                </table>
                                
                                <h5 class="text-primary mb-3 mt-4">Status & Audit</h5>
                                <table class="table table-borderless">
                                    <tr><td class="fw-bold">Status:</td><td>
                                        {% set status = invoice['audit_status'] or 'pending' %}
                                        {% if status == 'approved' %}
                                            <span class="badge bg-success">Approved</span>
                                        {% elif status == 'review' or status == 'pending' %}
                                            <span class="badge bg-warning">Pending Review</span>
                                        {% else %}
                                            <span class="badge bg-danger">{{ status.title() }}</span>
                                        {% endif %}
                                    </td></tr>
                                    <tr><td class="fw-bold">Audit Exception:</td><td>{{ invoice['audit_exception_status'] or 'None' }}</td></tr>
                                    <tr><td class="fw-bold">Audit Notes:</td><td>{{ invoice['audit_notes'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Created:</td><td>{{ invoice['created_at'][:10] if invoice['created_at'] else 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Updated:</td><td>{{ invoice['updated_at'][:10] if invoice['updated_at'] else 'N/A' }}</td></tr>
                                </table>
                                
                                <h5 class="text-primary mb-3 mt-4">Data Summary</h5>
                                <table class="table table-borderless">
                                    <tr><td class="fw-bold">Charges:</td><td>{{ charges|length if charges else 0 }} records</td></tr>
                                    <tr><td class="fw-bold">Line Items:</td><td>{{ line_items|length if line_items else 0 }} records</td></tr>
                                    <tr><td class="fw-bold">References:</td><td>{{ reference_numbers|length if reference_numbers else 0 }} records</td></tr>
                                    <tr><td class="fw-bold">Shipments:</td><td>{{ shipments|length if shipments else 0 }} records</td></tr>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Addresses Tab -->
                    <div class="tab-pane fade" id="addresses" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <h5 class="text-primary mb-3">Shipper Information</h5>
                                <table class="table table-borderless">
                                    <tr><td class="fw-bold">Shipper Name:</td><td>{{ invoice['shipper_name'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Address:</td><td>{{ invoice['shipper_address'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">City:</td><td>{{ invoice['shipper_city'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">State:</td><td>{{ invoice['shipper_state'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Postal Code:</td><td>{{ invoice['shipper_postal_code'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Country:</td><td>{{ invoice['shipper_country'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Plant:</td><td>{{ invoice['shipper_plant'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Company Code:</td><td>{{ invoice['shipper_company_code'] or 'N/A' }}</td></tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <h5 class="text-primary mb-3">Consignee Information</h5>
                                <table class="table table-borderless">
                                    <tr><td class="fw-bold">Consignee Name:</td><td>{{ invoice['consignee_name'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Address:</td><td>{{ invoice['consignee_address'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">City:</td><td>{{ invoice['consignee_city'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">State:</td><td>{{ invoice['consignee_state'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Postal Code:</td><td>{{ invoice['consignee_postal_code'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Country:</td><td>{{ invoice['consignee_country'] or 'N/A' }}</td></tr>
                                </table>
                            </div>
                        </div>
                        
                        <div class="row mt-4">
                            <div class="col-md-6">
                                <h5 class="text-primary mb-3">Bill To Information</h5>
                                <table class="table table-borderless">
                                    <tr><td class="fw-bold">Bill To Name:</td><td>{{ invoice['bill_to_name'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Address:</td><td>{{ invoice['bill_to_address'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">City:</td><td>{{ invoice['bill_to_city'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">State:</td><td>{{ invoice['bill_to_state'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Postal Code:</td><td>{{ invoice['bill_to_postal_code'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Country:</td><td>{{ invoice['bill_to_country'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Billed To Type:</td><td>{{ invoice['billed_to_type'] or 'N/A' }}</td></tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <h5 class="text-primary mb-3">Carrier Information</h5>
                                <table class="table table-borderless">
                                    <tr><td class="fw-bold">Carrier Name:</td><td>{{ invoice['carrier_name'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Address:</td><td>{{ invoice['carrier_address'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">City:</td><td>{{ invoice['carrier_city'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">State:</td><td>{{ invoice['carrier_state'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Postal Code:</td><td>{{ invoice['carrier_postal_code'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Country:</td><td>{{ invoice['carrier_country'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">VAT Registration:</td><td>{{ invoice['carrier_vat_registration'] or 'N/A' }}</td></tr>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Charges Tab -->
                    <div class="tab-pane fade" id="charges" role="tabpanel">
                        {% if charges %}
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead class="table-primary">
                                    <tr>
                                        <th>Charge Type</th>
                                        <th>Description</th>
                                        <th>Rate</th>
                                        <th>Quantity</th>
                                        <th>Unit</th>
                                        <th class="text-end">Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for charge in charges %}
                                    <tr>
                                        <td class="fw-bold">{{ charge['charge_type'] or 'N/A' }}</td>
                                        <td>{{ charge['description'] or 'N/A' }}</td>
                                        <td>${{ "%.4f"|format(charge['rate'] or 0.0) }}</td>
                                        <td>{{ "%.2f"|format(charge['quantity'] or 0.0) }}</td>
                                        <td>{{ charge['unit'] or 'N/A' }}</td>
                                        <td class="text-end fw-bold">${{ "%.2f"|format(charge['amount'] or 0.0) }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot class="table-secondary">
                                    <tr>
                                        <th colspan="5" class="text-end">Total:</th>
                                        <th class="text-end">${{ "%.2f"|format(invoice['invoice_amount'] or 0.0) }}</th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>No charge details available for this invoice.
                        </div>
                        {% endif %}
                    </div>

                    <!-- Line Items Tab -->
                    <div class="tab-pane fade" id="line-items" role="tabpanel">
                        {% if line_items %}
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead class="table-primary">
                                    <tr>
                                        <th>Line Number</th>
                                        <th>Description</th>
                                        <th>Weight (KG)</th>
                                        <th>Quantity</th>
                                        <th>Unit Type</th>
                                        <th>Volume</th>
                                        <th>Dimensions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in line_items %}
                                    <tr>
                                        <td class="fw-bold">{{ item['line_number'] or 'N/A' }}</td>
                                        <td>{{ item['item_description'] or 'N/A' }}</td>
                                        <td>{{ "%.1f"|format(item['weight'] or 0.0) }} kg</td>
                                        <td>{{ "%.0f"|format(item['quantity'] or 0) }}</td>
                                        <td>{{ item['unit_type'] or 'N/A' }}</td>
                                        <td>{{ "%.2f"|format(item['volume'] or 0.0) }}</td>
                                        <td>{{ item['dimensions'] or 'N/A' }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <h5 class="text-primary mb-3">Weight & Volume Summary</h5>
                                <table class="table table-borderless">
                                    <tr><td class="fw-bold">Bill Weight:</td><td>{{ "%.1f"|format(invoice['bill_weight'] or 0.0) }} kg</td></tr>
                                    <tr><td class="fw-bold">Ship Weight:</td><td>{{ "%.1f"|format(invoice['ship_weight'] or 0.0) }} kg</td></tr>
                                    <tr><td class="fw-bold">Total Weight:</td><td>{{ "%.1f"|format(total_weight_kg or 0.0) }} kg</td></tr>
                                    <tr><td class="fw-bold">Total Quantity:</td><td>{{ "%.0f"|format(total_pieces or 0) }}</td></tr>
                                    <tr><td class="fw-bold">Volume:</td><td>{{ invoice['volume'] or 'N/A' }}</td></tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <h5 class="text-primary mb-3">Weight Analysis</h5>
                                <table class="table table-borderless">
                                    <tr>
                                        <td class="fw-bold">Bill Weight:</td>
                                        <td>{{ "%.1f"|format(invoice['bill_weight'] or 0.0) }} kg</td>
                                        <td class="text-muted">(Billed weight)</td>
                                    </tr>
                                    <tr>
                                        <td class="fw-bold">Ship Weight:</td>
                                        <td>{{ "%.1f"|format(invoice['ship_weight'] or 0.0) }} kg</td>
                                        <td class="text-muted">(Actual weight)</td>
                                    </tr>
                                    {% if invoice['bill_weight'] and invoice['ship_weight'] and invoice['bill_weight'] != invoice['ship_weight'] %}
                                    <tr class="text-warning">
                                        <td class="fw-bold">Weight Difference:</td>
                                        <td>{{ "%.1f"|format((invoice['bill_weight'] or 0.0) - (invoice['ship_weight'] or 0.0)) }} kg</td>
                                        <td class="text-muted">(Bill - Ship)</td>
                                    </tr>
                                    {% endif %}
                                </table>
                            </div>
                        </div>
                        {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>No line item details available for this invoice.
                        </div>
                        {% endif %}
                    </div>

                    <!-- References Tab -->
                    <div class="tab-pane fade" id="references" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <h5 class="text-primary mb-3">Reference Numbers</h5>
                                <table class="table table-borderless">
                                    <tr><td class="fw-bold">PRO Number:</td><td>{{ invoice['pro_number'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Reference Number:</td><td>{{ invoice['reference_number'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Bill of Lading:</td><td>{{ invoice['bill_of_lading'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Booking Number:</td><td>{{ invoice['booking_number'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Container Number:</td><td>{{ invoice['container_number'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Tracking Number:</td><td>{{ invoice['tracking_number'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Vessel Name:</td><td>{{ invoice['vessel_name'] or 'N/A' }}</td></tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <h5 class="text-primary mb-3">Additional Information</h5>
                                <table class="table table-borderless">
                                    <tr><td class="fw-bold">Account Number:</td><td>{{ invoice['account_number'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Account Period:</td><td>{{ invoice['account_period'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Vendor Number:</td><td>{{ invoice['vendor_number'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Customer VAT:</td><td>{{ invoice['customer_vat_registration'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">SAP Plant:</td><td>{{ invoice['sap_plant'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">GL Account:</td><td>{{ invoice['gl_account'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Profit Center:</td><td>{{ invoice['profit_center'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Tax Code:</td><td>{{ invoice['tax_code'] or 'N/A' }}</td></tr>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Additional Reference Numbers from reference_numbers table -->
                        {% if reference_numbers %}
                        <div class="mt-4">
                            <h5 class="text-primary mb-3">Additional Reference Numbers</h5>
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead class="table-primary">
                                        <tr>
                                            <th>Reference Type</th>
                                            <th>Reference Value</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for ref in reference_numbers %}
                                        <tr>
                                            <td class="fw-bold">{{ ref['reference_type'] or 'N/A' }}</td>
                                            <td>{{ ref['reference_value'] or 'N/A' }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Shipment Tab -->
                    <div class="tab-pane fade" id="shipment" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <h5 class="text-primary mb-3">Shipment Details</h5>
                                <table class="table table-borderless">
                                    <tr><td class="fw-bold">Service Type:</td><td>{{ invoice['service_type'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Transportation Mode:</td><td>{{ invoice['mode'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Shipping Mode:</td><td>{{ invoice['shipping_mode'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Direction:</td><td>{{ invoice['direction'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Incoterm:</td><td>{{ invoice['incoterm'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Delivery Commitment:</td><td>{{ invoice['delivery_commitment'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Commodity Type:</td><td>{{ invoice['commodity_type'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Charge Group:</td><td>{{ invoice['charge_group'] or 'N/A' }}</td></tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <h5 class="text-primary mb-3">Dates & Locations</h5>
                                <table class="table table-borderless">
                                    <tr><td class="fw-bold">Service Date:</td><td>{{ invoice['service_date'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Pickup Date:</td><td>{{ invoice['pickup_date'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Delivery Date:</td><td>{{ invoice['delivery_date'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Ship Date:</td><td>{{ invoice['ship_date'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Origin Port:</td><td>{{ invoice['origin_port'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Destination Port:</td><td>{{ invoice['destination_port'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Shipment Entered:</td><td>{{ invoice['shipment_entered_date'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Invoice Created:</td><td>{{ invoice['invoice_created_date'] or 'N/A' }}</td></tr>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Shipment table data if available -->
                        {% if shipments %}
                        <div class="mt-4">
                            <h5 class="text-primary mb-3">Shipment Records</h5>
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead class="table-primary">
                                        <tr>
                                            <th>Origin Location</th>
                                            <th>Destination Location</th>
                                            <th>Pickup Date</th>
                                            <th>Delivery Date</th>
                                            <th>Service Type</th>
                                            <th>Weight</th>
                                            <th>Dimensions</th>
                                            <th>Package Count</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for shipment in shipments %}
                                        <tr>
                                            <td>{{ shipment['origin_location'] or 'N/A' }}</td>
                                            <td>{{ shipment['destination_location'] or 'N/A' }}</td>
                                            <td>{{ shipment['pickup_date'] or 'N/A' }}</td>
                                            <td>{{ shipment['delivery_date'] or 'N/A' }}</td>
                                            <td>{{ shipment['service_type'] or 'N/A' }}</td>
                                            <td>{{ "%.1f"|format(shipment['weight'] or 0.0) }}</td>
                                            <td>{{ shipment['dimensions'] or 'N/A' }}</td>
                                            <td>{{ shipment['package_count'] or 'N/A' }}</td>
                                            <td>{{ shipment['status'] or 'N/A' }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Technical Tab -->
                    <div class="tab-pane fade" id="technical" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <h5 class="text-primary mb-3">File Information</h5>
                                <table class="table table-borderless">
                                    <tr><td class="fw-bold">Uploaded File:</td><td>{{ invoice['uploaded_file_path'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Raw EDI Size:</td><td>{{ (invoice['raw_edi']|length if invoice['raw_edi'] else 0) }} characters</td></tr>
                                    <tr><td class="fw-bold">Processing Status:</td><td>{{ invoice['invoice_status'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Allocation %:</td><td>{{ "%.2f"|format(invoice['allocation_percentage'] or 0.0) }}%</td></tr>
                                    <tr><td class="fw-bold">Company Code:</td><td>{{ invoice['company_code'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Master Shipper Address:</td><td>{{ invoice['master_shipper_address'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Shipper Description:</td><td>{{ invoice['shipper_description'] or 'N/A' }}</td></tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <h5 class="text-primary mb-3">System Information</h5>
                                <table class="table table-borderless">
                                    <tr><td class="fw-bold">Database ID:</td><td>{{ invoice['id'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Created At:</td><td>{{ invoice['created_at'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Updated At:</td><td>{{ invoice['updated_at'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Recipient Description:</td><td>{{ invoice['recipient_description'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Recipient Type:</td><td>{{ invoice['recipient_type'] or 'N/A' }}</td></tr>
                                    <tr><td class="fw-bold">Partner Bank Type:</td><td>{{ invoice['partner_bank_type'] or 'N/A' }}</td></tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="row">
    <div class="col-12">
        <div class="alert alert-warning">
            <h4 class="alert-heading">Invoice Not Found</h4>
            <p>The requested invoice could not be found in the system.</p>
            <hr>
            <p class="mb-0"><a href="{{ url_for('invoice.invoices') }}" class="btn btn-primary">Return to Invoices</a></p>
        </div>
    </div>
</div>
{% endif %}
</div>

<script>
// Initialize Bootstrap tabs
const triggerTabList = [].slice.call(document.querySelectorAll('#invoiceDetailTabs button'))
triggerTabList.forEach(function (triggerEl) {
    const tabTrigger = new bootstrap.Tab(triggerEl);
    
    triggerEl.addEventListener('click', function (event) {
        event.preventDefault();
        tabTrigger.show();
    });
});

// Air Freight Audit functionality
function auditAirFreight() {
    const invoiceId = {{ invoice['id'] }};
    const auditButton = document.getElementById('auditButton');
    
    // Disable the button during audit
    auditButton.disabled = true;
    auditButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Auditing...';
    
    // Call the audit API
    fetch(`/api/audit/air/${invoiceId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        // Re-enable the button
        auditButton.disabled = false;
        auditButton.innerHTML = '<i class="fas fa-search-dollar me-2"></i>Audit Air Freight';
        
        if (data.success) {
            // Create audit results card
            showAuditResults(data);
        } else {
            // Show error message
            alert(`Audit failed: ${data.message}`);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        auditButton.disabled = false;
        auditButton.innerHTML = '<i class="fas fa-search-dollar me-2"></i>Audit Air Freight';
        alert('An error occurred during the audit process.');
    });
}

function showAuditResults(auditData) {
    // Check if audit results section already exists, and remove it if it does
    const existingResults = document.getElementById('auditResultsSection');
    if (existingResults) {
        existingResults.remove();
    }
    
    // Create the audit results card
    const resultsSection = document.createElement('div');
    resultsSection.id = 'auditResultsSection';
    resultsSection.className = 'row mt-4';
    
    // Set the status color based on audit result
    let statusClass = 'bg-warning';
    let statusIcon = 'fa-exclamation-triangle';
    
    if (auditData.status === 'approved') {
        statusClass = 'bg-success';
        statusIcon = 'fa-check-circle';
    } else if (auditData.status === 'flagged') {
        statusClass = 'bg-danger';
        statusIcon = 'fa-times-circle';
    }
    
    // Format the variance
    const variance = auditData.variance;
    const variancePct = auditData.variance_pct;
    const varianceFormatted = variance >= 0 ? `+$${variance.toFixed(2)}` : `-$${Math.abs(variance).toFixed(2)}`;
    const variancePctFormatted = variancePct >= 0 ? `+${variancePct.toFixed(2)}%` : `${variancePct.toFixed(2)}%`;
    
    resultsSection.innerHTML = `
        <div class="col-12">
            <div class="card border-${statusClass === 'bg-success' ? 'success' : (statusClass === 'bg-danger' ? 'danger' : 'warning')}">
                <div class="card-header ${statusClass} text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas ${statusIcon} me-2"></i>
                            Air Freight Audit Results
                        </h5>
                        <span class="badge bg-white text-dark">Status: ${auditData.status.toUpperCase()}</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="border-bottom pb-2">Invoice Information</h6>
                            <dl class="row">
                                <dt class="col-sm-4">Invoice Number</dt>
                                <dd class="col-sm-8">${auditData.invoice_number}</dd>
                                
                                <dt class="col-sm-4">Origin</dt>
                                <dd class="col-sm-8">${auditData.origin}</dd>
                                
                                <dt class="col-sm-4">Destination</dt>
                                <dd class="col-sm-8">${auditData.destination}</dd>
                                
                                <dt class="col-sm-4">Weight</dt>
                                <dd class="col-sm-8">${auditData.weight_kg} kg</dd>
                            </dl>
                        </div>
                        <div class="col-md-6">
                            <h6 class="border-bottom pb-2">Audit Results</h6>
                            <dl class="row">
                                <dt class="col-sm-5">Actual Charges</dt>
                                <dd class="col-sm-7">$${auditData.actual_charges.toFixed(2)}</dd>
                                
                                <dt class="col-sm-5">Expected Charges</dt>
                                <dd class="col-sm-7">$${auditData.expected_charges.toFixed(2)}</dd>
                                
                                <dt class="col-sm-5">Variance</dt>
                                <dd class="col-sm-7">
                                    <span class="text-${variance > 0 ? 'danger' : (variance < 0 ? 'success' : 'dark')}">
                                        ${varianceFormatted} (${variancePctFormatted})
                                    </span>
                                </dd>
                                
                                <dt class="col-sm-5">Reference Lane</dt>
                                <dd class="col-sm-7">${auditData.lane_id}</dd>
                            </dl>
                        </div>
                    </div>
                    
                    <div class="alert alert-${statusClass === 'bg-success' ? 'success' : (statusClass === 'bg-danger' ? 'danger' : 'warning')} mt-3">
                        <i class="fas ${statusIcon} me-2"></i>
                        ${auditData.message}
                    </div>
                    
                    <div class="mt-3">
                        <h6 class="border-bottom pb-2">Rate Details</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>Item</th>
                                        <th>Rate</th>
                                        <th>Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Base Rate (${auditData.rate_details.applicable_rate}/kg)</td>
                                        <td>$${auditData.rate_details.applicable_rate.toFixed(2)}/kg</td>
                                        <td>$${auditData.rate_details.base_cost.toFixed(2)}</td>
                                    </tr>
                                    <tr>
                                        <td>Fuel Surcharge</td>
                                        <td>$${auditData.rate_details.fuel_surcharge.toFixed(2)}/kg</td>
                                        <td>$${auditData.rate_details.fuel_cost.toFixed(2)}</td>
                                    </tr>
                                    <tr>
                                        <td>Origin Fees</td>
                                        <td>$${auditData.rate_details.origin_fees.toFixed(2)}/kg</td>
                                        <td>$${auditData.rate_details.origin_fees_cost.toFixed(2)}</td>
                                    </tr>
                                    <tr>
                                        <td>Destination Fees</td>
                                        <td>$${auditData.rate_details.destination_fees.toFixed(2)}/kg</td>
                                        <td>$${auditData.rate_details.destination_fees_cost.toFixed(2)}</td>
                                    </tr>
                                    <tr>
                                        <td>PSS Charge</td>
                                        <td>$${auditData.rate_details.pss_charge.toFixed(2)}/kg</td>
                                        <td>$${auditData.rate_details.pss_cost.toFixed(2)}</td>
                                    </tr>
                                    <tr class="table-primary">
                                        <th>Total Expected</th>
                                        <td></td>
                                        <th>$${auditData.expected_charges.toFixed(2)}</th>
                                    </tr>
                                    ${auditData.rate_details.min_charge_applied ? `
                                    <tr>
                                        <td colspan="3" class="text-muted"><small>* Minimum charge of $${auditData.rate_details.min_charge.toFixed(2)} applied</small></td>
                                    </tr>
                                    ` : ''}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Add the audit results to the page
    const tabContent = document.querySelector('.tab-content');
    tabContent.parentNode.insertBefore(resultsSection, tabContent);
    
    // Scroll to the audit results
    resultsSection.scrollIntoView({behavior: 'smooth'});
}
    });
});
</script>
{% endblock %}
