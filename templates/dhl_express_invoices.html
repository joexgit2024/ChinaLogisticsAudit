{% extends "base.html" %}
{% block title %}DHL Express Invoices{% endblock %}

{% block content %}
<style>
    .nav-link {
        color: #D70018 !important;
        border-radius: 10px;
        margin: 0 5px;
    }
    .nav-link:hover {
        background-color: #D70018 !important;
        color: white !important;
    }
    .nav-link.active {
        background-color: #D70018 !important;
        color: white !important;
    }
    .table-hover tbody tr:hover {
        background-color: #fff5f5;
    }
    .btn-dhl {
        background-color: #D70018;
        border-color: #D70018;
        color: white;
    }
    .btn-dhl:hover {
        background-color: #B80015;
        border-color: #B80015;
        color: white;
    }
    .status-badge {
        font-size: 0.8em;
        padding: 0.25em 0.6em;
    }
</style>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1><i class="fas fa-file-invoice"></i> DHL Express Invoices</h1>
            <p class="text-muted">Manage and view all loaded DHL Express invoice data</p>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-md-6">
            <div class="input-group">
                <span class="input-group-text"><i class="fas fa-search"></i></span>
                <input type="text" class="form-control" id="searchInput" placeholder="Search invoices...">
            </div>
        </div>
        <div class="col-md-6 text-end">
            <a href="/dhl-express/batch-audit/results" class="btn btn-outline-primary me-2">
                <i class="fas fa-chart-bar"></i> Check Batch Audit Summary
            </a>
            <a href="/dhl-express/upload" class="btn btn-dhl">
                <i class="fas fa-upload"></i> Upload New Invoices
            </a>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h5><i class="fas fa-list"></i> Invoice List ({{ invoices|length }} invoices)</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="invoicesTable">
                    <thead>
                        <tr>
                            <th>Invoice No</th>
                            <th>Date</th>
                            <th>Company</th>
                                <th>Lines</th>
                                <th>Total Amount</th>
                                <th>Loaded Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for invoice in invoices %}
                            <tr>
                                <td>
                                    <strong>{{ invoice.invoice_no }}</strong>
                                </td>
                                <td>{{ invoice.invoice_date }}</td>
                                <td>{{ invoice.company_name }}</td>
                                <td>
                                    <span class="badge bg-secondary">{{ invoice.line_count }} lines</span>
                                </td>
                                <td>
                                    <strong>${{ "{:,.2f}".format(invoice.total_amount) }}</strong>
                                </td>
                                <td>
                                    <small class="text-muted">{{ invoice.loaded_date[:10] if invoice.loaded_date else '' }}</small>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <a href="/dhl-express/invoice/{{ invoice.invoice_no }}" 
                                           class="btn btn-outline-primary" title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="/dhl-express/audit/{{ invoice.invoice_no }}" 
                                           class="btn btn-outline-success" title="Audit Invoice">
                                            <i class="fas fa-search"></i>
                                        </a>
                                        <button class="btn btn-outline-info" 
                                                onclick="downloadInvoice('{{ invoice.invoice_no }}')" 
                                                title="Download">
                                            <i class="fas fa-download"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                {% if not invoices %}
                <div class="text-center py-5">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No invoices found</h5>
                    <p class="text-muted">Upload DHL Express invoice CSV files to get started.</p>
                    <a href="/dhl-express/upload" class="btn btn-dhl">
                        <i class="fas fa-upload"></i> Upload Invoices
                    </a>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Summary Cards -->
        {% if invoices %}
        <div class="row mt-4">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h3 class="text-danger">{{ invoices|length }}</h3>
                        <p class="text-muted mb-0">Total Invoices</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h3 class="text-danger">{{ invoices|sum(attribute='line_count') }}</h3>
                        <p class="text-muted mb-0">Total Lines</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h3 class="text-danger">${{ "{:,.0f}".format(invoices|sum(attribute='total_amount')) }}</h3>
                        <p class="text-muted mb-0">Total Value</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h3 class="text-danger">${{ "{:,.0f}".format((invoices|sum(attribute='total_amount')) / (invoices|length)) if invoices|length > 0 else 0 }}</h3>
                        <p class="text-muted mb-0">Avg. Invoice</p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Search functionality
        document.getElementById('searchInput').addEventListener('keyup', function() {
            const searchTerm = this.value.toLowerCase();
            const tableRows = document.querySelectorAll('#invoicesTable tbody tr');
            
            tableRows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });

        function downloadInvoice(invoiceNo) {
            // Show brief loading indication
            const button = event.target.closest('button');
            const originalContent = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            button.disabled = true;
            
            // Create a temporary anchor element to trigger download
            const link = document.createElement('a');
            link.href = `/dhl-express/invoice/${invoiceNo}/download`;
            link.download = `DHL_Express_Invoice_${invoiceNo}.xlsx`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Reset button after a short delay
            setTimeout(() => {
                button.innerHTML = originalContent;
                button.disabled = false;
            }, 1500);
        }

        // Auto-refresh every 30 seconds
        setTimeout(() => {
            location.reload();
        }, 30000);
    </script>
</div>
{% endblock %}
