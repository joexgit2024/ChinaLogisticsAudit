{% extends "base.html" %}

{% block title %}Performance Analysis - DHL Invoice Audit{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Performance Analysis</h2>
    <p class="text-muted">
        This page shows detailed timing metrics for recent PDF processing operations from your actual uploads to help identify performance bottlenecks.
    </p>

    {% if error %}
    <div class="alert alert-danger">
        Error: {{ error }}
    </div>
    {% endif %}

    {% if performance_data %}
    <!-- Summary Section -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h4>Performance Summary</h4>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div id="avgTimingChart" style="height: 300px;"></div>
                </div>
                <div class="col-md-6">
                    <h5>Performance Bottlenecks</h5>
                    <div id="bottleneckAnalysis" class="mt-3">
                        <div class="alert alert-info">
                            Analyzing performance data...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Timing Section -->
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h4>Recent Processing Times</h4>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Invoice</th>
                            <th>Filename</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Total Time (s)</th>
                            <th>PDF Extraction (s)</th>
                            <th>LLM Processing (s)</th>
                            <th>Database (s)</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in performance_data %}
                        <tr class="{{ 'table-danger' if item.status and item.status != 'Success' else 'table-warning' if item.get('partial_processing') else '' }}">
                            <td>{{ item.invoice_no }}</td>
                            <td>{{ item.pdf_filename }}</td>
                            <td>{{ item.processing_timestamp }}</td>
                            <td>
                                {% if item.status and item.status != 'Success' %}
                                <span class="badge badge-danger">{{ item.status }}</span>
                                {% elif item.get('partial_processing') %}
                                <span class="badge badge-warning">Partial</span>
                                {% elif item.get('success') is defined and not item.get('success') %}
                                <span class="badge badge-danger">Failed</span>
                                {% else %}
                                <span class="badge badge-success">Success</span>
                                {% endif %}
                            </td>
                            <td>{{ item.timing.total_processing_time|default('-', true) }}</td>
                            <td>{{ item.timing.pdf_extraction|default('-', true) }}</td>
                            <td>{{ item.timing.llm_processing|default('-', true) }}</td>
                            <td>{{ item.timing.database_save|default('-', true) }}</td>
                            <td>
                                <button type="button" class="btn btn-sm btn-info" 
                                        data-toggle="modal" data-target="#detailModal{{ loop.index }}">
                                    View Details
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Detail Modals -->
    {% for item in performance_data %}
    <div class="modal fade" id="detailModal{{ loop.index }}" tabindex="-1" role="dialog" aria-labelledby="detailModalLabel{{ loop.index }}" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="detailModalLabel{{ loop.index }}">Performance Details for {{ item.invoice_no }}</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    {% if item.get('error') %}
                    <div class="alert alert-danger">
                        <strong>Processing Error:</strong> {{ item.get('error') }}
                    </div>
                    {% endif %}
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Processing Information</h6>
                            <ul class="list-group">
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Invoice Number
                                    <span class="badge badge-primary badge-pill">{{ item.invoice_no }}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Filename
                                    <span class="badge badge-primary badge-pill">{{ item.pdf_filename }}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Processing Date
                                    <span class="badge badge-primary badge-pill">{{ item.processing_timestamp }}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Status
                                    {% if item.get('partial_processing') %}
                                    <span class="badge badge-warning">Partial Processing</span>
                                    {% elif item.get('success') is defined and not item.get('success') %}
                                    <span class="badge badge-danger">Failed</span>
                                    {% else %}
                                    <span class="badge badge-success">Complete</span>
                                    {% endif %}
                                </li>
                                {% if item.confidence is defined %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Confidence Score
                                    <span class="badge badge-{{ 'success' if item.confidence >= 0.8 else 'warning' if item.confidence >= 0.6 else 'danger' }}">
                                        {{ "%.1f"|format(item.confidence * 100) }}%
                                    </span>
                                </li>
                                {% endif %}
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <canvas id="timingChart{{ loop.index }}" width="100%" height="200"></canvas>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h6>Detailed Timing Breakdown</h6>
                        {% if item.timing %}
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Processing Step</th>
                                        <th>Time (seconds)</th>
                                        <th>% of Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for key, value in item.timing.items() %}
                                    <tr>
                                        <td>{{ key|replace('_', ' ')|title }}</td>
                                        <td>{{ value }}</td>
                                        <td>
                                            {% if 'total_processing_time' in item.timing and item.timing.total_processing_time %}
                                                {{ "%.1f"|format((value / item.timing.total_processing_time * 100)) }}%
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% if item.get('partial_processing') %}
                        <div class="alert alert-warning mt-2">
                            <i class="fas fa-exclamation-triangle mr-2"></i> These timing metrics are partial due to processing interruption.
                        </div>
                        {% endif %}
                        {% else %}
                        <div class="alert alert-warning">
                            No timing data available for this processing attempt.
                        </div>
                        {% endif %}
                    </div>

                    <div class="mt-3">
                        <h6>Performance Analysis</h6>
                        <div class="alert alert-info">
                            {% set bottleneck = {'step': '', 'time': 0} %}
                            {% for key, value in item.timing.items() %}
                                {% if key != 'total_processing_time' and value > bottleneck.time %}
                                    {% if bottleneck.update({'step': key, 'time': value}) %}{% endif %}
                                {% endif %}
                            {% endfor %}
                            
                            <strong>Main bottleneck:</strong> {{ bottleneck.step|replace('_', ' ')|title }} ({{ "%.1f"|format((bottleneck.time / item.timing.total_processing_time * 100) if item.timing.total_processing_time else 0) }}% of total time)
                            
                            <br><br>
                            <strong>Recommendations:</strong><br>
                            {% if 'pdf_extraction' in item.timing and item.timing.pdf_extraction > (item.timing.total_processing_time or 0) * 0.3 %}
                                • Consider optimizing PDF extraction by using batching or parallel processing.<br>
                            {% endif %}
                            
                            {% if 'llm_processing' in item.timing and item.timing.llm_processing > (item.timing.total_processing_time or 0) * 0.4 %}
                                • LLM processing is slow - consider using a more optimized model or reducing prompt size.<br>
                            {% endif %}
                            
                            {% if 'database_save' in item.timing and item.timing.database_save > (item.timing.total_processing_time or 0) * 0.2 %}
                                • Database operations are taking significant time - consider adding indexes or batch operations.<br>
                            {% endif %}
                            
                            {% if 'ollama_connection_check' in item.timing and item.timing.ollama_connection_check > (item.timing.total_processing_time or 0) * 0.1 %}
                                • Ollama connection checks are slow - consider implementing connection pooling.<br>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}

    <!-- JavaScript for Charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    // Define the runBenchmark function in the global scope
    function runBenchmark() {
            console.log('runBenchmark function called');
            
            // Check if a file is actually selected
            const fileInput = document.getElementById('pdfFile');
            console.log('File input element:', fileInput);
            
            if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                alert('Please select a PDF file first!');
                return;
            }
            
            const selectedFile = fileInput.files[0];
            console.log('Selected file:', selectedFile ? selectedFile.name : 'none', 'Size:', selectedFile ? selectedFile.size : 0);
            
            // Show progress and update button immediately
            console.log('Showing progress bar...');
            const progressBar = document.querySelector('#benchmarkProgress');
            const progressBarInner = progressBar.querySelector('.progress-bar');
            const runBenchmarkBtn = document.getElementById('runBenchmarkBtn');
            const statusText = document.getElementById('benchmarkStatus');
            
            // Update button state first
            runBenchmarkBtn.disabled = true;
            runBenchmarkBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Starting Benchmark...';
            statusText.textContent = 'Initializing benchmark test...';
            statusText.className = 'text-info';
            
            // Show progress bar
            progressBar.classList.remove('d-none');
            progressBarInner.style.width = '10%';
            progressBarInner.textContent = 'Preparing...';
            
            console.log('Progress bar should now be visible');
            
            // Create a new FormData object manually to ensure the file is included
            const formData = new FormData();
            formData.append('pdf_file', selectedFile);
            
            // Add other form values
            const iterations = document.getElementById('iterations').value || '1';
            formData.append('iterations', iterations);
            
            const useSchema = document.getElementById('useSchemaExtraction').checked;
            formData.append('use_schema_extraction', useSchema ? 'true' : 'false');
            
            // Double check that the file is included in the FormData
            if (!formData.get('pdf_file') || formData.get('pdf_file').size === 0) {
                console.error('File not properly attached to FormData');
                alert('Error: The file could not be processed. Please try selecting it again.');
                progressBar.classList.add('d-none');
                runBenchmarkBtn.disabled = false;
                runBenchmarkBtn.innerHTML = '<i class="fas fa-tachometer-alt me-2"></i> Run Performance Benchmark';
                return;
            }
            
            console.log('Sending file:', formData.get('pdf_file').name, 'Size:', formData.get('pdf_file').size);
            
            // Update progress to show we're starting the request
            progressBarInner.style.width = '30%';
            progressBarInner.textContent = 'Sending request...';
            runBenchmarkBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Processing PDF...';
            
            // Make API request - ensure directory exists first
            fetch('/llm-pdf/api/ensure-temp-dir', { 
                method: 'GET',
                headers: {
                    'Cache-Control': 'no-cache'
                }
            })
            .then(() => {
                console.log('Temp directory check completed, sending benchmark request');
                progressBarInner.style.width = '50%';
                progressBarInner.textContent = 'Running benchmark...';
                
                // Now send the actual benchmark request
                return fetch('/llm-pdf/api/run-benchmark', {
                    method: 'POST',
                    body: formData
                });
            })
            .then(response => {
                progressBarInner.style.width = '80%';
                progressBarInner.textContent = 'Processing response...';
                console.log('Server response status:', response.status);
                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Benchmark response received:', data);
                progressBarInner.style.width = '100%';
                progressBarInner.textContent = 'Complete!';
                
                setTimeout(() => {
                    displayBenchmarkResults(data);
                    progressBar.classList.add('d-none');
                    runBenchmarkBtn.disabled = false;
                    runBenchmarkBtn.innerHTML = '<i class="fas fa-tachometer-alt me-2"></i> Run Performance Benchmark';
                }, 500);
            })
            .catch(error => {
                console.error('Error running benchmark:', error);
                progressBar.classList.add('d-none');
                runBenchmarkBtn.disabled = false;
                runBenchmarkBtn.innerHTML = '<i class="fas fa-tachometer-alt me-2"></i> Run Performance Benchmark';
                
                // Display error in results area
                const resultsDiv = document.getElementById('benchmarkResults');
                resultsDiv.classList.remove('d-none');
                const summaryDiv = document.getElementById('benchmarkSummary');
                summaryDiv.innerHTML = `<div class="alert alert-danger">
                    <h5>Benchmark Error</h5>
                    <p><strong>Error:</strong> ${error.message || 'An unknown error occurred while running the benchmark.'}</p>
                    <p>Please check the browser console (F12) and server logs for more details.</p>
                    <p><strong>Troubleshooting tips:</strong></p>
                    <ul>
                        <li>Make sure Ollama is running and the DeepSeek-R1 model is loaded</li>
                        <li>Check that the PDF file is valid and not corrupted</li>
                        <li>Try with a smaller PDF file or fewer iterations</li>
                        <li>Refresh the page and try again</li>
                    </ul>
                </div>`;
            });
        }
        
        function displayBenchmarkResults(data) {
            const resultsDiv = document.getElementById('benchmarkResults');
            resultsDiv.classList.remove('d-none');
            
            // Display summary
            const summaryDiv = document.getElementById('benchmarkSummary');
            if (data.success && data.summary) {
                let summaryHtml = `<h6>Benchmark Summary</h6>
                    <p>Completed ${data.summary.iterations_completed} out of ${data.summary.iterations_requested} iterations.</p>`;
                
                if (data.summary.average_times) {
                    summaryHtml += '<p><strong>Average Processing Times:</strong></p><ul>';
                    for (const [step, time] of Object.entries(data.summary.average_times)) {
                        const stepName = step.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                        summaryHtml += `<li>${stepName}: ${time} seconds</li>`;
                    }
                    summaryHtml += '</ul>';
                    
                    // Create chart with benchmark data
                    createBenchmarkChart(data.summary.average_times);
                }
                
                summaryDiv.innerHTML = summaryHtml;
            } else {
                summaryDiv.innerHTML = `<p class="text-danger">Benchmark failed: ${data.error || 'Unknown error'}</p>`;
            }
        }
        
        function createBenchmarkChart(timingData) {
            const ctx = document.getElementById('benchmarkChart').getContext('2d');
            
            // Filter out total_processing_time
            const filteredData = {};
            Object.entries(timingData).forEach(([key, value]) => {
                if (key !== 'total_processing_time') {
                    filteredData[key] = value;
                }
            });
            
            const labels = Object.keys(filteredData).map(key => 
                key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase())
            );
            const data = Object.values(filteredData);
            
            // Define colors
            const backgroundColor = [
                '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b',
                '#858796', '#5a5c69', '#2e59d9', '#17a673', '#2c9faf'
            ];
            
            if (window.benchmarkChart) {
                window.benchmarkChart.destroy();
            }
            
            window.benchmarkChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Processing Time (seconds)',
                        data: data,
                        backgroundColor: backgroundColor,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'PDF Processing Time Breakdown'
                        },
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Seconds'
                            }
                        }
                    }
                }
            });
        }
        // Process timing data from Flask template
        const performanceData = [
            {% for item in performance_data %}
            {
                invoice: "{{ item.invoice_no }}",
                filename: "{{ item.pdf_filename }}",
                status: "{{ item.status if item.status else 'Success' }}",
                partial_processing: {% if item.get('partial_processing') %}true{% else %}false{% endif %},
                timing: {
                    {% for key, value in item.timing.items() if item.timing %}
                    "{{ key }}": {{ value }},
                    {% endfor %}
                }
            },
            {% endfor %}
        ];
        
        // Filter out entries with no timing data for charts
        const validPerformanceData = performanceData.filter(item => 
            item.timing && Object.keys(item.timing).length > 0 &&
            item.timing.hasOwnProperty('total_processing_time')
        );
        
        // Calculate averages for summary chart (only use successful runs)
        const successfulData = validPerformanceData.filter(item => item.status === 'Success');
        if (successfulData.length > 0) {
            const avgTimings = calculateAverages(successfulData);
            createAveragePieChart(avgTimings);
        } else {
            document.getElementById('avgPieChart').innerHTML = 
                '<div class="alert alert-info">No successful processing data available for average chart.</div>';
        }
        
        // Create individual charts for each item with valid timing data
        validPerformanceData.forEach((item, index) => {
            createDetailChart(item, index + 1);
        });
        
        // Create bottleneck analysis (use all valid timing data)
        if (validPerformanceData.length > 0) {
            createBottleneckAnalysis(validPerformanceData);
        } else {
            document.getElementById('bottleneckAnalysis').innerHTML = 
                '<div class="alert alert-info">No timing data available for bottleneck analysis.</div>';
        }
    });
    
    function calculateAverages(data) {
        const steps = new Set();
        data.forEach(item => {
            Object.keys(item.timing).forEach(key => {
                if (key !== 'total_processing_time') {
                    steps.add(key);
                }
            });
        });
        
        const result = {};
        steps.forEach(step => {
            let sum = 0;
            let count = 0;
            data.forEach(item => {
                if (item.timing[step]) {
                    sum += item.timing[step];
                    count++;
                }
            });
            if (count > 0) {
                result[step] = sum / count;
            }
        });
        
        return result;
    }
    
    function createAveragePieChart(avgTimings) {
        const ctx = document.getElementById('avgTimingChart').getContext('2d');
        
        const labels = Object.keys(avgTimings).map(key => {
            return key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
        });
        
        const data = Object.values(avgTimings);
        const backgroundColor = [
            '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b',
            '#858796', '#5a5c69', '#2e59d9', '#17a673', '#2c9faf'
        ];
        
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: backgroundColor,
                    hoverBackgroundColor: backgroundColor,
                    hoverBorderColor: 'white'
                }]
            },
            options: {
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right'
                    },
                    title: {
                        display: true,
                        text: 'Average Processing Time by Step'
                    }
                }
            }
        });
    }
    
    function createDetailChart(item, index) {
        const ctx = document.getElementById(`timingChart${index}`);
        if (!ctx) return;
        
        // If item has no timing data or empty timing data, show error message
        if (!item.timing || Object.keys(item.timing).length === 0) {
            ctx.parentElement.innerHTML = '<div class="alert alert-warning">No timing data available for this processing attempt.</div>';
            return;
        }
        
        const filteredTiming = Object.fromEntries(
            Object.entries(item.timing).filter(([key]) => key !== 'total_processing_time')
        );
        
        // If no steps data available after filtering, show message
        if (Object.keys(filteredTiming).length === 0) {
            ctx.parentElement.innerHTML = '<div class="alert alert-warning">No detailed step timing data available.</div>';
            return;
        }
        
        const labels = Object.keys(filteredTiming).map(key => {
            return key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
        });
        
        const data = Object.values(filteredTiming);
        
        // Use different colors for failed vs successful runs
        const isFailure = item.status && item.status !== 'Success';
        const backgroundColor = isFailure ? 
            ['#e74a3b', '#f6c23e', '#858796', '#5a5c69'] :  // Red-based palette for failures
            ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', 
             '#858796', '#5a5c69', '#2e59d9', '#17a673', '#2c9faf'];
        
        // Make sure we have enough colors for all data points
        const extendedColors = [];
        for (let i = 0; i < data.length; i++) {
            extendedColors.push(backgroundColor[i % backgroundColor.length]);
        }
        
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: extendedColors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: 'Processing Time Breakdown (seconds)'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    function createBottleneckAnalysis(performanceData) {
        // Identify common bottlenecks
        const stepCounts = {};
        const errorCounts = {};
        let totalItems = performanceData.length;
        let failedItems = 0;
        
        performanceData.forEach(item => {
            // Track failed items
            if (item.status && item.status !== 'Success') {
                failedItems++;
                const errorType = item.status;
                errorCounts[errorType] = (errorCounts[errorType] || 0) + 1;
            }
            
            // Skip if no timing data or invalid timing data
            if (!item.timing || Object.keys(item.timing).length === 0) {
                return;
            }
            
            // Find the bottleneck for this item
            let maxStep = '';
            let maxTime = 0;
            
            Object.entries(item.timing).forEach(([step, time]) => {
                if (step !== 'total_processing_time' && time > maxTime) {
                    maxStep = step;
                    maxTime = time;
                }
            });
            
            if (maxStep) {
                stepCounts[maxStep] = (stepCounts[maxStep] || 0) + 1;
            }
        });
        
        // Sort bottlenecks by frequency
        const sortedBottlenecks = Object.entries(stepCounts)
            .sort((a, b) => b[1] - a[1])
            .map(([step, count]) => {
                const percentage = (count / totalItems * 100).toFixed(0);
                const formattedStep = step.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                return { step: formattedStep, percentage, count };
            });
        
        // Sort errors by frequency
        const sortedErrors = Object.entries(errorCounts)
            .sort((a, b) => b[1] - a[1])
            .map(([errorType, count]) => {
                const percentage = (count / totalItems * 100).toFixed(0);
                return { type: errorType, count, percentage };
            });
        
        // Generate recommendations
        let html = '';
        
        // Add error summary if there are failures
        if (failedItems > 0) {
            const failureRate = ((failedItems / totalItems) * 100).toFixed(0);
            html += `
            <div class="alert alert-danger mb-4">
                <h6 class="mb-2"><i class="fas fa-exclamation-triangle"></i> Processing Failures</h6>
                <p>Processing failed for <strong>${failedItems}</strong> of ${totalItems} PDFs (${failureRate}% failure rate).</p>
                <ul class="list-group">`;
                
            sortedErrors.forEach(error => {
                html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>${error.type}</span>
                    <span class="badge badge-danger badge-pill">${error.count} occurrences</span>
                </li>`;
            });
            
            html += `</ul>
            </div>`;
        }
        
        html += '<h6>Common Bottlenecks</h6><ul class="list-group mb-3">';
        
        sortedBottlenecks.forEach(b => {
            html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                ${b.step}
                <span class="badge badge-primary badge-pill">${b.percentage}% of cases</span>
            </li>`;
        });
        
        html += '</ul><h6>Optimization Recommendations</h6>';
        
        // PDF extraction bottlenecks
        if (stepCounts['pdf_extraction']) {
            html += `
            <div class="alert alert-warning">
                <strong>PDF Extraction Optimizations:</strong>
                <ul>
                    <li>Use page batching for faster processing of large PDFs</li>
                    <li>Consider parallel processing for multi-page documents</li>
                    <li>Optimize PyMuPDF flags for faster text extraction</li>
                    <li>Implement caching for frequently processed PDFs</li>
                </ul>
            </div>`;
        }
        
        // LLM processing bottlenecks
        if (stepCounts['llm_processing']) {
            html += `
            <div class="alert alert-warning">
                <strong>LLM Processing Optimizations:</strong>
                <ul>
                    <li>Reduce prompt size by focusing on essential text</li>
                    <li>Use a more optimized/quantized model</li>
                    <li>Try different temperature/sampling parameters</li>
                    <li>Process PDFs in smaller chunks</li>
                    <li>Use a more powerful GPU if available</li>
                </ul>
            </div>`;
        }
        
        // Database bottlenecks
        if (stepCounts['database_save']) {
            html += `
            <div class="alert alert-warning">
                <strong>Database Optimizations:</strong>
                <ul>
                    <li>Add indexes to frequently queried columns</li>
                    <li>Use batch operations for line items</li>
                    <li>Implement connection pooling</li>
                    <li>Move database operations to background threads</li>
                </ul>
            </div>`;
        }
        
        // General recommendations
        html += `
        <div class="alert alert-info">
            <strong>General Recommendations:</strong>
            <ul>
                <li>Implement result caching for repeated operations</li>
                <li>Process files asynchronously with a job queue</li>
                <li>Add progress feedback for better user experience</li>
                <li>Consider scaling horizontally with multiple workers</li>
            </ul>
        </div>`;
        
        document.getElementById('bottleneckAnalysis').innerHTML = html;
    }
    
    // Set up the event listeners when the document is ready
    document.addEventListener('DOMContentLoaded', function() {
        // Set up benchmark form submission
        const benchmarkForm = document.getElementById('benchmarkForm');
        if (benchmarkForm) {
            benchmarkForm.addEventListener('submit', function(e) {
                e.preventDefault();
                runBenchmark();
            });
            
            // Add click handler for the button as well
            const runBenchmarkBtn = document.getElementById('runBenchmarkBtn');
            if (runBenchmarkBtn) {
                runBenchmarkBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    runBenchmark();
                });
            }
            
            console.log('Benchmark form event listeners set up successfully');
        }
    });
    </script>
    {% else %}
    <div class="alert alert-info">
        <h5><i class="fas fa-info-circle me-2"></i>No Performance Data Available</h5>
        <p>No performance metrics are available yet. To see performance analytics, you need to:</p>
        <ol>
            <li><strong>Process some PDFs</strong> using the <a href="/llm-pdf/upload" class="alert-link">LLM PDF Upload & Processing</a> page</li>
            <li><strong>Wait for processing to complete</strong> - you'll see timing information during processing</li>
            <li><strong>Return to this page</strong> to view the performance analytics</li>
        </ol>
        <hr>
        <p class="mb-0">
            <i class="fas fa-lightbulb me-1"></i> 
            <strong>Tip:</strong> The performance analysis shows detailed timing breakdowns from your actual PDF processing operations, 
            including time spent on PDF extraction, LLM processing, database operations, and more.
        </p>
    </div>
    {% endif %}
</div>
{% endblock %}
