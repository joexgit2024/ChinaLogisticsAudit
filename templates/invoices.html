{% extends "base.html" %}
{% block title %}Invoices{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">All Invoices</h1>
    <div>
        <a href="{{ url_for('download.download_bulk_invoices') }}" class="btn btn-outline-success me-2">
            <i class="fas fa-download me-2"></i>Export All
        </a>
        <a href="{{ url_for('core.upload_file') }}" class="btn btn-primary btn-custom">
            <i class="fas fa-upload me-2"></i>Upload New File
        </a>
    </div>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" class="row g-3">
            <div class="col-md-3">
                <label for="status" class="form-label">Status</label>
                <select class="form-select" id="status" name="status">
                    <option value="">All Statuses</option>
                    <option value="pending" {% if request.args.get('status') == 'pending' %}selected{% endif %}>Pending</option>
                    <option value="approved" {% if request.args.get('status') == 'approved' %}selected{% endif %}>Approved</option>
                    <option value="review" {% if request.args.get('status') == 'review' %}selected{% endif %}>Review</option>
                    <option value="flagged" {% if request.args.get('status') == 'flagged' %}selected{% endif %}>Flagged</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="search" class="form-label">Search</label>
                <input type="text" class="form-control" id="search" name="search" 
                       placeholder="Invoice #, Shipper, etc." value="{{ request.args.get('search', '') }}">
            </div>
            <div class="col-md-2">
                <label for="date_from" class="form-label">From Date</label>
                <input type="date" class="form-control" id="date_from" name="date_from"
                       value="{{ request.args.get('date_from', '') }}">
            </div>
            <div class="col-md-2">
                <label for="date_to" class="form-label">To Date</label>
                <input type="date" class="form-control" id="date_to" name="date_to"
                       value="{{ request.args.get('date_to', '') }}">
            </div>
            <div class="col-md-2">
                <label class="form-label">&nbsp;</label>
                <div class="d-grid">
                    <button type="submit" class="btn btn-outline-primary">
                        <i class="fas fa-search me-2"></i>Filter
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Invoices Table -->
<div class="card">
    <div class="card-body">
        {% if invoices %}
            <!-- Filter results summary -->
            {% if request.args.get('status') or request.args.get('search') or request.args.get('date_from') or request.args.get('date_to') %}
                <div class="alert alert-info mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>
                            <i class="fas fa-filter me-2"></i>Showing {{ total }} filtered results
                            {% if request.args.get('status') %}
                                <span class="badge bg-secondary ms-2">Status: {{ request.args.get('status') }}</span>
                            {% endif %}
                            {% if request.args.get('search') %}
                                <span class="badge bg-secondary ms-2">Search: "{{ request.args.get('search') }}"</span>
                            {% endif %}
                            {% if request.args.get('date_from') %}
                                <span class="badge bg-secondary ms-2">From: {{ request.args.get('date_from') }}</span>
                            {% endif %}
                            {% if request.args.get('date_to') %}
                                <span class="badge bg-secondary ms-2">To: {{ request.args.get('date_to') }}</span>
                            {% endif %}
                        </span>
                        <a href="{{ url_for('invoice.invoices') }}" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-times me-1"></i>Clear Filters
                        </a>
                    </div>
                </div>
            {% endif %}
            <div class="table-responsive">
                <table class="table table-hover" id="invoicesTable">
                    <thead>
                        <tr>
                            <th class="sortable" data-column="1">
                                Invoice # <i class="fas fa-sort text-muted"></i>
                            </th>
                            <th class="sortable" data-column="2">
                                Shipper <i class="fas fa-sort text-muted"></i>
                            </th>
                            <th class="sortable" data-column="3">
                                Consignee <i class="fas fa-sort text-muted"></i>
                            </th>
                            <th class="sortable" data-column="route">
                                Route <i class="fas fa-sort text-muted"></i>
                            </th>
                            <th class="sortable" data-column="4" data-type="number">
                                Amount <i class="fas fa-sort text-muted"></i>
                            </th>
                            <th class="sortable" data-column="5" data-type="number">
                                Weight <i class="fas fa-sort text-muted"></i>
                            </th>
                            <th class="sortable" data-column="status">
                                Status <i class="fas fa-sort text-muted"></i>
                            </th>
                            <th class="sortable" data-column="date">
                                Date <i class="fas fa-sort text-muted"></i>
                            </th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for invoice in invoices %}
                        <tr>
                            <td>
                                {% if invoice[1] %}
                                    <a href="{{ url_for('invoice.invoice_detail_by_number', invoice_number=invoice[1]) }}?t={{ now|default(0, true) }}" 
                                       class="text-decoration-none fw-bold">
                                        {{ invoice[1] }}
                                    </a>
                                {% else %}
                                    <span class="fw-bold text-muted">N/A</span>
                                {% endif %}
                            </td>
                            <td>{{ invoice[2] or 'Unknown' }}</td>
                            <td>{{ invoice[3] or 'Unknown' }}</td>
                            <td>
                                {% set origin_port = invoice[6] %}
                                {% set dest_port = invoice[7] %}
                                {% set origin_country = invoice[8] %}
                                {% set dest_country = invoice[9] %}
                                
                                {% if origin_port and dest_port %}
                                    <small class="text-muted">{{ origin_port }} → {{ dest_port }}</small>
                                {% elif origin_country and dest_country %}
                                    <small class="text-muted">{{ origin_country }} → {{ dest_country }}</small>
                                {% else %}
                                    <small class="text-muted">Origin → Destination</small>
                                {% endif %}
                            </td>
                            <td>
                                <span class="fw-bold">${{ "%.2f"|format(invoice[4] or 0) }}</span>
                            </td>
                            <td>{{ "%.1f"|format(invoice[5] or 0) }} kg</td>
                            <td>
                                {% set status = invoice[11] or 'pending' %}
                                {% if status == 'approved' %}
                                    <span class="badge bg-success">Approved</span>
                                {% elif status == 'review' or status == 'pending' %}
                                    <span class="badge bg-warning">Pending</span>
                                {% else %}
                                    <span class="badge bg-danger">Flagged</span>
                                {% endif %}
                            </td>
                            <td>{{ invoice[12][:10] if invoice[12] else 'N/A' }}</td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    {% if invoice[1] %}
                                        <a href="{{ url_for('invoice.invoice_detail_by_number', invoice_number=invoice[1]) }}" 
                                           class="btn btn-outline-primary btn-sm">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    {% else %}
                                        <button class="btn btn-outline-primary btn-sm" disabled>
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    {% endif %}
                                    <button class="btn btn-outline-success btn-sm" 
                                            onclick="auditInvoice('{{ invoice[0] }}')">
                                        <i class="fas fa-search"></i>
                                    </button>
                                    <div class="btn-group btn-group-sm dropdown">
                                        <button type="button" class="btn btn-outline-secondary btn-sm dropdown-toggle" 
                                                data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="fas fa-download"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li><a class="dropdown-item" href="{{ url_for('download.download_invoice_json', invoice_id=invoice[0]) }}">
                                                <i class="fas fa-file-code me-2"></i>JSON Format
                                            </a></li>
                                            <li><a class="dropdown-item" href="{{ url_for('download.download_invoice_csv', invoice_id=invoice[0]) }}">
                                                <i class="fas fa-file-csv me-2"></i>CSV Format
                                            </a></li>
                                            <li><a class="dropdown-item" href="{{ url_for('download.download_invoice_edi', invoice_id=invoice[0]) }}">
                                                <i class="fas fa-file-alt me-2"></i>Original EDI
                                            </a></li>
                                        </ul>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            {% if total > per_page %}
            <nav aria-label="Invoice pagination">
                <ul class="pagination justify-content-center mt-4">
                    {% set total_pages = (total + per_page - 1) // per_page %}
                    
                    {% if page > 1 %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('invoice.invoices', page=page-1, status=request.args.get('status', ''), search=request.args.get('search', ''), date_from=request.args.get('date_from', ''), date_to=request.args.get('date_to', '')) }}">Previous</a>
                        </li>
                    {% endif %}
                    
                    {% for p in range(1, total_pages + 1) %}
                        {% if p == page %}
                            <li class="page-item active">
                                <span class="page-link">{{ p }}</span>
                            </li>
                        {% elif p <= 3 or p > total_pages - 3 or (p >= page - 2 and p <= page + 2) %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('invoice.invoices', page=p, status=request.args.get('status', ''), search=request.args.get('search', ''), date_from=request.args.get('date_from', ''), date_to=request.args.get('date_to', '')) }}">{{ p }}</a>
                            </li>
                        {% elif p == 4 or p == total_pages - 3 %}
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if page < total_pages %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('invoice.invoices', page=page+1, status=request.args.get('status', ''), search=request.args.get('search', ''), date_from=request.args.get('date_from', ''), date_to=request.args.get('date_to', '')) }}">Next</a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
            
        {% else %}
            <div class="text-center py-5">
                <i class="fas fa-inbox fa-4x text-muted mb-3"></i>
                <h4 class="text-muted">No Invoices Found</h4>
                <p class="text-muted">Upload an EDI file to start processing invoices.</p>
                <a href="{{ url_for('core.upload_file') }}" class="btn btn-primary btn-custom">
                    <i class="fas fa-upload me-2"></i>Upload EDI File
                </a>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
.sortable {
    cursor: pointer;
    user-select: none;
}

.sortable:hover {
    background-color: #f8f9fa;
}

.sortable i {
    margin-left: 5px;
    font-size: 0.8em;
}

.sort-asc i:before {
    content: "\f0de"; /* fa-sort-up */
}

.sort-desc i:before {
    content: "\f0dd"; /* fa-sort-down */
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const table = document.getElementById('invoicesTable');
    const headers = table.querySelectorAll('th.sortable');
    
    headers.forEach(header => {
        header.addEventListener('click', function() {
            const column = this.dataset.column;
            const dataType = this.dataset.type || 'text';
            
            // Remove sort classes from all headers
            headers.forEach(h => {
                h.classList.remove('sort-asc', 'sort-desc');
                const icon = h.querySelector('i');
                icon.className = 'fas fa-sort text-muted';
            });
            
            // Determine sort direction
            const currentSort = this.dataset.currentSort || 'none';
            const newSort = currentSort === 'asc' ? 'desc' : 'asc';
            this.dataset.currentSort = newSort;
            
            // Update header appearance
            this.classList.add('sort-' + newSort);
            const icon = this.querySelector('i');
            icon.className = newSort === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
            
            // Sort the table
            sortTable(column, newSort, dataType);
        });
    });
    
    function sortTable(column, direction, dataType) {
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        
        rows.sort((a, b) => {
            let aVal, bVal;
            
            if (column === 'route') {
                aVal = a.cells[3].textContent.trim();
                bVal = b.cells[3].textContent.trim();
            } else if (column === 'status') {
                aVal = a.cells[6].textContent.trim();
                bVal = b.cells[6].textContent.trim();
            } else if (column === 'date') {
                aVal = a.cells[7].textContent.trim();
                bVal = b.cells[7].textContent.trim();
            } else {
                const colIndex = parseInt(column);
                aVal = a.cells[colIndex].textContent.trim();
                bVal = b.cells[colIndex].textContent.trim();
            }
            
            if (dataType === 'number') {
                // Extract numeric values
                aVal = parseFloat(aVal.replace(/[$,]/g, '')) || 0;
                bVal = parseFloat(bVal.replace(/[$,]/g, '')) || 0;
            } else {
                // Text comparison
                aVal = aVal.toLowerCase();
                bVal = bVal.toLowerCase();
            }
            
            if (direction === 'asc') {
                return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
            } else {
                return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
            }
        });
        
        // Clear tbody and append sorted rows
        tbody.innerHTML = '';
        rows.forEach(row => tbody.appendChild(row));
    }
});
</script>
{% endblock %}
