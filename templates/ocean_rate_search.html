{% extends "base.html" %}
{% block title %}Search Ocean Rates{% endblock %}

{% block head %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/css/bootstrap-select.min.css" rel="stylesheet">
<style>
    .bootstrap-select .dropdown-toggle {
        border: 1px solid #ced4da;
    }
    .bootstrap-select .dropdown-toggle:focus {
        border-color: #86b7fe;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    .search-example-buttons .btn {
        margin: 2px;
    }
    .origin-destination-icons {
        position: relative;
    }
    .origin-destination-icons::after {
        content: "→";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 1.5em;
        color: #6c757d;
        z-index: 1;
    }
</style>
{% endblock %}

{% block content %}
<body>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else ('warning' if category == 'warning' else 'success') }} alert-dismissible fade show">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="row">
            <div class="col">
                <h1><i class="fas fa-search text-primary me-2"></i>Search Ocean Freight Rates</h1>
                <p class="text-muted">Find ocean freight rates by origin, destination, and service type</p>
            </div>
        </div>

        <!-- Search Form -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-filter me-2"></i>Search Filters</h5>
            </div>
            <div class="card-body">
                <form method="GET" id="searchForm">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="origin" class="form-label">Origin</label>
                            <select class="form-select" id="origin" name="origin" data-live-search="true">
                                <option value="">Select Origin...</option>
                                {% if origins %}
                                    {% set current_country = '' %}
                                    {% for origin in origins %}
                                        {% if origin[0] != current_country %}
                                            {% if current_country != '' %}</optgroup>{% endif %}
                                            {% set current_country = origin[0] %}
                                            <optgroup label="{{ origin[0] }}">
                                        {% endif %}
                                        <option value="{{ origin[1] }}" 
                                                data-subtext="{{ origin[0] }}"
                                                {{ 'selected' if search_params.origin == origin[1] else '' }}>
                                            {{ origin[1] }}
                                        </option>
                                        {% if loop.last %}</optgroup>{% endif %}
                                    {% endfor %}
                                {% else %}
                                    <!-- Fallback static options if no data -->
                                    <optgroup label="Countries">
                                        <option value="IN" {{ 'selected' if search_params.origin == 'IN' else '' }}>India</option>
                                        <option value="CN" {{ 'selected' if search_params.origin == 'CN' else '' }}>China</option>
                                        <option value="US" {{ 'selected' if search_params.origin == 'US' else '' }}>United States</option>
                                    </optgroup>
                                {% endif %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="destination" class="form-label">Destination</label>
                            <select class="form-select" id="destination" name="destination" data-live-search="true">
                                <option value="">Select Destination...</option>
                                {% if destinations %}
                                    {% set current_country = '' %}
                                    {% for dest in destinations %}
                                        {% if dest[0] != current_country %}
                                            {% if current_country != '' %}</optgroup>{% endif %}
                                            {% set current_country = dest[0] %}
                                            <optgroup label="{{ dest[0] }}">
                                        {% endif %}
                                        <option value="{{ dest[1] }}" 
                                                data-subtext="{{ dest[0] }}"
                                                {{ 'selected' if search_params.destination == dest[1] else '' }}>
                                            {{ dest[1] }}
                                        </option>
                                        {% if loop.last %}</optgroup>{% endif %}
                                    {% endfor %}
                                {% else %}
                                    <!-- Fallback static options if no data -->
                                    <optgroup label="Countries">
                                        <option value="CZ" {{ 'selected' if search_params.destination == 'CZ' else '' }}>Czech Republic</option>
                                        <option value="NL" {{ 'selected' if search_params.destination == 'NL' else '' }}>Netherlands</option>
                                        <option value="SG" {{ 'selected' if search_params.destination == 'SG' else '' }}>Singapore</option>
                                    </optgroup>
                                {% endif %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="service" class="form-label">Service</label>
                            <select class="form-select" id="service" name="service">
                                <option value="">All Services</option>
                                {% if services %}
                                    {% for service in services %}
                                        <option value="{{ service[0] }}" {{ 'selected' if search_params.service == service[0] else '' }}>
                                            {{ service[0] }}
                                        </option>
                                    {% endfor %}
                                {% else %}
                                    <option value="Ocean" {{ 'selected' if search_params.service == 'Ocean' else '' }}>Ocean</option>
                                {% endif %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="container_type" class="form-label">Container Type</label>
                            <select class="form-select" id="container_type" name="container_type">
                                <option value="">All Types</option>
                                <option value="20ft" {{ 'selected' if search_params.container_type == '20ft' else '' }}>20' Container</option>
                                <option value="40ft" {{ 'selected' if search_params.container_type == '40ft' else '' }}>40' Container</option>
                                <option value="40hc" {{ 'selected' if search_params.container_type == '40hc' else '' }}>40'HC Container</option>
                                <option value="lcl" {{ 'selected' if search_params.container_type == 'lcl' else '' }}>LCL</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search me-1"></i>Search Rates
                            </button>
                            <a href="{{ url_for('ocean_rate.search_rates') }}" class="btn btn-secondary">
                                <i class="fas fa-times me-1"></i>Clear
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Search Results -->
        {% if rates %}
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-list me-2"></i>Search Results ({{ rates|length }} rates found)</h5>
                    <div>
                        <button class="btn btn-sm btn-outline-primary" onclick="exportResults()">
                            <i class="fas fa-download me-1"></i>Export
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="resultsTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>Lane ID</th>
                                    <th>Service</th>
                                    <th>Origin</th>
                                    <th>Destination</th>
                                    <th>Transit (Days)</th>
                                    <th>20' FCL</th>
                                    <th>40' FCL</th>
                                    <th>40'HC FCL</th>
                                    <th>LCL Min</th>
                                    <th>LCL/CBM</th>
                                    <th>Valid Until</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for rate in rates %}
                                <tr>
                                    <td>
                                        <strong>{{ rate.lane_id }}</strong><br>
                                        <small class="text-muted">{{ rate.lane_description }}</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">{{ rate.service or 'N/A' }}</span>
                                    </td>
                                    <td>
                                        <strong>{{ rate.origin_country }}</strong><br>
                                        <small>{{ rate.lane_origin }}</small>
                                        {% if rate.port_of_loading %}
                                            <br><small class="text-muted">Port: {{ rate.port_of_loading }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <strong>{{ rate.destination_country }}</strong><br>
                                        <small>{{ rate.lane_destination }}</small>
                                        {% if rate.port_of_discharge %}
                                            <br><small class="text-muted">Port: {{ rate.port_of_discharge }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">{{ rate.dtd_transit_days or 'N/A' }}</span>
                                    </td>
                                    <td>
                                        {% if rate.total_20ft %}
                                            <strong>${{ "{:,.2f}".format(rate.total_20ft) }}</strong>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if rate.total_40ft %}
                                            <strong>${{ "{:,.2f}".format(rate.total_40ft) }}</strong>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if rate.total_40hc %}
                                            <strong>${{ "{:,.2f}".format(rate.total_40hc) }}</strong>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if rate.lcl_total_min_usd %}
                                            <strong>${{ "{:,.2f}".format(rate.lcl_total_min_usd) }}</strong>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if rate.lcl_total_usd_per_cbm %}
                                            <strong>${{ "{:,.2f}".format(rate.lcl_total_usd_per_cbm) }}</strong>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small>{{ rate.rate_validity or 'N/A' }}</small>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-info" 
                                                onclick="viewRateDetail('{{ rate.lane_id }}')"
                                                title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        {% elif search_params.origin or search_params.destination or search_params.service %}
            <div class="card">
                <div class="card-body text-center">
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <h5>No rates found</h5>
                    <p class="text-muted">Try adjusting your search criteria</p>
                </div>
            </div>
        {% else %}
            <div class="card">
                <div class="card-body text-center">
                    <i class="fas fa-ship fa-3x text-muted mb-3"></i>
                    <h5>Ready to search</h5>
                    <p class="text-muted">Enter search criteria above to find ocean freight rates</p>
                </div>
            </div>
        {% endif %}

        <!-- Quick Search Examples -->
        <div class="card mt-4">
            <div class="card-header">
                <h6><i class="fas fa-lightbulb me-2"></i>Quick Search Examples</h6>
            </div>
            <div class="card-body">
                <div class="row search-example-buttons">
                    <div class="col-md-4">
                        <h6>By Origin:</h6>
                        {% if origins %}
                            {% set unique_origins = origins[:6] %}
                            {% for origin in unique_origins %}
                                <button class="btn btn-outline-primary btn-sm" 
                                        onclick="quickSearch('', '', '{{ origin[1] }}', '')">
                                    From {{ origin[1] }}
                                </button>
                            {% endfor %}
                        {% else %}
                            <button class="btn btn-outline-primary btn-sm" onclick="quickSearch('', '', 'Goa', '')">From Goa</button>
                            <button class="btn btn-outline-primary btn-sm" onclick="quickSearch('', '', 'Mumbai', '')">From Mumbai</button>
                        {% endif %}
                    </div>
                    <div class="col-md-4">
                        <h6>By Destination:</h6>
                        {% if destinations %}
                            {% set unique_destinations = destinations[:6] %}
                            {% for dest in unique_destinations %}
                                <button class="btn btn-outline-success btn-sm" 
                                        onclick="quickSearch('', '', '', '{{ dest[1] }}')">
                                    To {{ dest[1] }}
                                </button>
                            {% endfor %}
                        {% else %}
                            <button class="btn btn-outline-success btn-sm" onclick="quickSearch('', '', '', 'Brno')">To Brno</button>
                            <button class="btn btn-outline-success btn-sm" onclick="quickSearch('', '', '', 'Singapore')">To Singapore</button>
                        {% endif %}
                    </div>
                    <div class="col-md-4">
                        <h6>Popular Routes:</h6>
                        <button class="btn btn-outline-info btn-sm" 
                                onclick="quickSearch('', '', 'Goa', 'Brno')">Goa → Brno</button>
                        <button class="btn btn-outline-info btn-sm" 
                                onclick="quickSearch('', '', 'Goa', 'Veenendaal')">Goa → Veenendaal</button>
                        {% if services %}
                            {% for service in services %}
                                <button class="btn btn-outline-secondary btn-sm" 
                                        onclick="quickSearch('{{ service[0] }}', '', '', '')">{{ service[0] }}</button>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/js/bootstrap-select.min.js"></script>
    <script>
        // Initialize Bootstrap Select
        $(document).ready(function() {
            $('#origin').selectpicker({
                liveSearch: true,
                showSubtext: true,
                showIcon: true,
                showContent: true
            });
            
            $('#destination').selectpicker({
                liveSearch: true,
                showSubtext: true,
                showIcon: true,
                showContent: true
            });
            
            $('#service').selectpicker();
            $('#container_type').selectpicker();
        });

        function quickSearch(service, containerType, origin, destination) {
            // Set the values
            $('#service').selectpicker('val', service);
            $('#container_type').selectpicker('val', containerType);
            $('#origin').selectpicker('val', origin);
            $('#destination').selectpicker('val', destination);
            
            // Submit the form
            document.getElementById('searchForm').submit();
        }

        function viewRateDetail(laneId) {
            // For now, just show an alert. Later, implement modal or detail page
            alert('Rate detail view for Lane: ' + laneId + '\n\nFull detail view coming soon!');
        }

        function exportResults() {
            // For now, just show an alert. Later, implement export functionality
            alert('Export functionality coming soon!');
        }

        // Form submission handling
        document.getElementById('searchForm').addEventListener('submit', function(e) {
            // Show loading indicator
            const submitBtn = document.querySelector('#searchForm button[type="submit"]');
            if (submitBtn) {
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Searching...';
                submitBtn.disabled = true;
                
                // Re-enable after a delay (in case of errors)
                setTimeout(() => {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }, 5000);
            }
        });

        // Auto-search when selections change
        function setupAutoSearch() {
            $('#origin, #destination, #service, #container_type').on('changed.bs.select', function() {
                // Add small delay to prevent too many rapid searches
                clearTimeout(window.searchTimeout);
                window.searchTimeout = setTimeout(() => {
                    const origin = $('#origin').val();
                    const destination = $('#destination').val();
                    const service = $('#service').val();
                    
                    // Only auto-search if at least one meaningful filter is selected
                    if (origin || destination || service) {
                        document.getElementById('searchForm').submit();
                    }
                }, 500);
            });
        }

        // Initialize auto-search after page load
        $(document).ready(function() {
            setupAutoSearch();
        });
    </script>
{% endblock %}
