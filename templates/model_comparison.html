{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h4><i class="fas fa-chart-bar"></i> Model Performance Comparison</h4>
                    <p class="text-muted mb-0">Run the same invoice through different models to compare accuracy and speed</p>
                </div>
                <div class="card-body">
                    <!-- File Upload Section -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card border-primary">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0"><i class="fas fa-upload"></i> Upload Invoice for Comparison</h5>
                                </div>
                                <div class="card-body">
                                    <form id="comparisonForm" enctype="multipart/form-data">
                                        <div class="form-group mb-3">
                                            <label for="pdfFile" class="form-label">PDF Invoice File:</label>
                                            <input type="file" class="form-control" id="pdfFile" name="pdf_file" accept=".pdf" required>
                                        </div>
                                        
                                        <div class="form-group mb-3">
                                            <label class="form-label">Select Models to Compare:</label>
                                            <div id="modelCheckboxes" class="mt-2">
                                                <!-- Models will be loaded here -->
                                            </div>
                                        </div>
                                        
                                        <button type="submit" class="btn btn-primary" id="runComparison">
                                            <i class="fas fa-play"></i> Run Model Comparison
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card border-info">
                                <div class="card-header bg-info text-white">
                                    <h5 class="mb-0"><i class="fas fa-info-circle"></i> Comparison Guide</h5>
                                </div>
                                <div class="card-body">
                                    <h6>What gets compared:</h6>
                                    <ul class="list-unstyled">
                                        <li><i class="fas fa-clock text-primary"></i> <strong>Processing Speed</strong> - Total time taken</li>
                                        <li><i class="fas fa-bullseye text-success"></i> <strong>Extraction Accuracy</strong> - Confidence scores</li>
                                        <li><i class="fas fa-database text-info"></i> <strong>Data Quality</strong> - Fields extracted</li>
                                        <li><i class="fas fa-memory text-warning"></i> <strong>Resource Usage</strong> - Model size impact</li>
                                    </ul>
                                    
                                    <h6 class="mt-3">Model Recommendations:</h6>
                                    <ul class="list-unstyled">
                                        <li><span class="badge bg-success">Fast</span> Llama3.2, Gemma3</li>
                                        <li><span class="badge bg-warning">Balanced</span> Mistral, Qwen2.5</li>
                                        <li><span class="badge bg-danger">Accurate</span> DeepSeek-R1</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Progress Section -->
                    <div id="progressSection" style="display: none;">
                        <div class="card border-warning">
                            <div class="card-header bg-warning">
                                <h5 class="mb-0"><i class="fas fa-spinner fa-spin"></i> Processing Comparison</h5>
                            </div>
                            <div class="card-body">
                                <div id="progressContainer">
                                    <!-- Progress bars will be added here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Results Section -->
                    <div id="resultsSection" style="display: none;">
                        <div class="card border-success">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0"><i class="fas fa-chart-line"></i> Comparison Results</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <canvas id="speedChart" width="400" height="200"></canvas>
                                    </div>
                                    <div class="col-md-6">
                                        <canvas id="accuracyChart" width="400" height="200"></canvas>
                                    </div>
                                </div>
                                
                                <div class="table-responsive mt-4">
                                    <table class="table table-striped" id="comparisonTable">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>Model</th>
                                                <th>Size</th>
                                                <th>Processing Time</th>
                                                <th>Confidence</th>
                                                <th>Fields Extracted</th>
                                                <th>Speed Rating</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="comparisonResults">
                                            <!-- Results will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Historical Comparisons -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-history"></i> Historical Model Performance</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm" id="historicalTable">
                                    <thead>
                                        <tr>
                                            <th>Invoice</th>
                                            <th>Model Used</th>
                                            <th>Processing Time</th>
                                            <th>Confidence</th>
                                            <th>Date</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="historicalResults">
                                        <!-- Historical data will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let availableModels = {};
let comparisonResults = [];

// Load available models and create checkboxes
async function loadModelsForComparison() {
    try {
        const response = await fetch('/llm-pdf/api/models');
        const data = await response.json();
        
        if (data.success) {
            availableModels = data.models;
            const container = document.getElementById('modelCheckboxes');
            
            Object.keys(availableModels).forEach(modelKey => {
                const model = availableModels[modelKey];
                const div = document.createElement('div');
                div.className = 'form-check';
                
                const speedClass = model.speed === 'Very Fast' ? 'success' : 
                                 model.speed === 'Fast' ? 'primary' : 
                                 model.speed === 'Medium' ? 'warning' : 'danger';
                
                div.innerHTML = `
                    <input class="form-check-input" type="checkbox" value="${modelKey}" id="model_${modelKey.replace(/[^a-zA-Z0-9]/g, '_')}">
                    <label class="form-check-label" for="model_${modelKey.replace(/[^a-zA-Z0-9]/g, '_')}">
                        <strong>${model.name}</strong> 
                        <span class="badge bg-${speedClass}">${model.speed}</span>
                        <span class="badge bg-secondary">${model.size}</span>
                        <br><small class="text-muted">${model.best_for}</small>
                    </label>
                `;
                container.appendChild(div);
            });
        }
    } catch (error) {
        console.error('Error loading models:', error);
        showAlert('Error loading models: ' + error.message, 'danger');
    }
}

// Handle form submission
document.getElementById('comparisonForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const fileInput = document.getElementById('pdfFile');
    const selectedModels = Array.from(document.querySelectorAll('#modelCheckboxes input:checked')).map(cb => cb.value);
    
    if (!fileInput.files[0]) {
        showAlert('Please select a PDF file', 'warning');
        return;
    }
    
    if (selectedModels.length < 2) {
        showAlert('Please select at least 2 models to compare', 'warning');
        return;
    }
    
    // Show progress section
    document.getElementById('progressSection').style.display = 'block';
    document.getElementById('resultsSection').style.display = 'none';
    
    comparisonResults = [];
    
    // Create progress bars
    const progressContainer = document.getElementById('progressContainer');
    progressContainer.innerHTML = '';
    
    selectedModels.forEach(modelKey => {
        const model = availableModels[modelKey];
        const progressDiv = document.createElement('div');
        progressDiv.className = 'mb-3';
        progressDiv.innerHTML = `
            <label class="form-label">${model.name} (${model.size})</label>
            <div class="progress">
                <div class="progress-bar" id="progress_${modelKey.replace(/[^a-zA-Z0-9]/g, '_')}" 
                     role="progressbar" style="width: 0%">Processing...</div>
            </div>
        `;
        progressContainer.appendChild(progressDiv);
    });
    
    // Process with each model
    for (const modelKey of selectedModels) {
        await processWithModel(fileInput.files[0], modelKey);
    }
    
    // Show results
    displayComparisonResults();
});

async function processWithModel(file, modelKey) {
    const formData = new FormData();
    formData.append('pdf_file', file);
    formData.append('selected_model', modelKey);
    
    const progressBar = document.getElementById(`progress_${modelKey.replace(/[^a-zA-Z0-9]/g, '_')}`);
    progressBar.style.width = '20%';
    progressBar.textContent = 'Uploading...';
    
    try {
        const startTime = Date.now();
        
        // Increase timeout for longer models (2 minutes for complex models)
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 120000); // 2 minutes timeout
        
        progressBar.style.width = '40%';
        progressBar.textContent = 'Processing with AI...';
        
        const response = await fetch('/llm-pdf/process-single', {
            method: 'POST',
            body: formData,
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        const endTime = Date.now();
        const processingTime = (endTime - startTime) / 1000;
        
        progressBar.style.width = '100%';
        
        if (response.ok) {
            const result = await response.json();
            
            if (result.success) {
                progressBar.textContent = `Complete (${processingTime.toFixed(1)}s)`;
                progressBar.className = 'progress-bar bg-success';
                
                comparisonResults.push({
                    model: modelKey,
                    modelName: availableModels[modelKey].name,
                    size: availableModels[modelKey].size,
                    speed: availableModels[modelKey].speed,
                    processingTime: processingTime,
                    confidence: result.confidence || 0,
                    fieldsExtracted: Object.keys(result.extracted_data || {}).length,
                    result: result,
                    success: true
                });
            } else {
                progressBar.textContent = 'Processing failed';
                progressBar.className = 'progress-bar bg-warning';
                
                comparisonResults.push({
                    model: modelKey,
                    modelName: availableModels[modelKey].name,
                    size: availableModels[modelKey].size,
                    speed: availableModels[modelKey].speed,
                    processingTime: processingTime,
                    confidence: 0,
                    fieldsExtracted: 0,
                    error: result.error || 'Processing failed',
                    success: false
                });
            }
        } else {
            // Get error details from response
            let errorMessage = `HTTP ${response.status}`;
            try {
                const errorData = await response.json();
                errorMessage = errorData.error || errorMessage;
            } catch (e) {
                errorMessage = await response.text() || errorMessage;
            }
            
            progressBar.className = 'progress-bar bg-danger';
            progressBar.textContent = `Failed: ${errorMessage}`;
            
            // Add failed result
            comparisonResults.push({
                model: modelKey,
                modelName: availableModels[modelKey].name,
                size: availableModels[modelKey].size,
                speed: availableModels[modelKey].speed,
                processingTime: null,
                confidence: 0,
                fieldsExtracted: 0,
                error: errorMessage,
                success: false
            });
        }
    } catch (error) {
        console.error(`Error processing with ${modelKey}:`, error);
        
        let errorMessage = error.message;
        if (error.name === 'AbortError') {
            errorMessage = 'Timeout (>2 minutes)';
            progressBar.className = 'progress-bar bg-warning';
        } else {
            progressBar.className = 'progress-bar bg-danger';
        }
        
        progressBar.textContent = `Error: ${errorMessage}`;
        
        // Add result with error details
        comparisonResults.push({
            model: modelKey,
            modelName: availableModels[modelKey].name,
            size: availableModels[modelKey].size,
            speed: availableModels[modelKey].speed,
            processingTime: null,
            confidence: 0,
            fieldsExtracted: 0,
            error: errorMessage,
            success: false
        });
    }
}

function displayComparisonResults() {
    document.getElementById('resultsSection').style.display = 'block';
    
    // Sort successful results by processing time
    const successfulResults = comparisonResults.filter(r => r.success);
    successfulResults.sort((a, b) => a.processingTime - b.processingTime);
    
    // Create charts only if we have successful results
    if (successfulResults.length > 0) {
        createSpeedChart(successfulResults);
        createAccuracyChart(successfulResults);
    } else {
        // Hide charts if no successful results
        document.getElementById('speedChart').style.display = 'none';
        document.getElementById('accuracyChart').style.display = 'none';
    }
    
    // Populate table with all results (successful and failed)
    const tbody = document.getElementById('comparisonResults');
    tbody.innerHTML = '';
    
    comparisonResults.forEach((result, index) => {
        const row = document.createElement('tr');
        if (result.success && index === 0) row.className = 'table-success'; // Fastest successful
        if (!result.success) row.className = 'table-danger'; // Failed
        
        const speedRating = result.success && result.processingTime ? 
            (result.processingTime < 5 ? 'A+' : 
             result.processingTime < 10 ? 'A' : 
             result.processingTime < 20 ? 'B' : 'C') : 'N/A';
        
        const processingTimeDisplay = result.success && result.processingTime ? 
            `${result.processingTime.toFixed(2)}s ${index === 0 && result.success ? '<span class="badge bg-success">Fastest</span>' : ''}` :
            `<span class="text-danger">Failed</span>`;
        
        const confidenceDisplay = result.success ? 
            `${(result.confidence * 100).toFixed(1)}%` : 
            `<span class="text-danger">N/A</span>`;
        
        const fieldsDisplay = result.success ? 
            result.fieldsExtracted : 
            `<span class="text-danger">0</span>`;
        
        const speedRatingDisplay = result.success ? 
            `<span class="badge bg-${speedRating === 'A+' ? 'success' : speedRating === 'A' ? 'primary' : speedRating === 'B' ? 'warning' : 'danger'}">${speedRating}</span>` :
            `<span class="badge bg-danger">Failed</span>`;
        
        const errorInfo = result.error ? 
            `<br><small class="text-danger">Error: ${result.error}</small>` : '';
        
        row.innerHTML = `
            <td><strong>${result.modelName}</strong>${errorInfo}</td>
            <td>${result.size}</td>
            <td>${processingTimeDisplay}</td>
            <td>${confidenceDisplay}</td>
            <td>${fieldsDisplay}</td>
            <td>${speedRatingDisplay}</td>
            <td>
                ${result.success ? 
                    `<button class="btn btn-sm btn-outline-primary" onclick="viewDetails('${result.model}')">
                        <i class="fas fa-eye"></i> Details
                    </button>` :
                    `<button class="btn btn-sm btn-outline-secondary" disabled>
                        <i class="fas fa-times"></i> Failed
                    </button>`
                }
            </td>
        `;
        tbody.appendChild(row);
    });
}

function createSpeedChart(results = comparisonResults.filter(r => r.success)) {
    const ctx = document.getElementById('speedChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: results.map(r => r.modelName),
            datasets: [{
                label: 'Processing Time (seconds)',
                data: results.map(r => r.processingTime),
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Processing Speed Comparison'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Seconds'
                    }
                }
            }
        }
    });
}

function createAccuracyChart(results = comparisonResults.filter(r => r.success)) {
    const ctx = document.getElementById('accuracyChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: results.map(r => r.modelName),
            datasets: [{
                label: 'Confidence (%)',
                data: results.map(r => r.confidence * 100),
                backgroundColor: 'rgba(75, 192, 192, 0.6)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Extraction Confidence Comparison'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Confidence %'
                    }
                }
            }
        }
    });
}

function showAlert(message, type) {
    // Simple alert for now
    alert(message);
}

function viewDetails(modelKey) {
    const result = comparisonResults.find(r => r.model === modelKey);
    if (result && result.success && result.result.invoice_no) {
        // Open details page with invoice number
        window.open(`/llm-pdf/results/${result.result.invoice_no}`, '_blank');
    } else {
        alert('No details available for this result');
    }
}

// Load historical data
async function loadHistoricalData() {
    try {
        const response = await fetch('/llm-pdf/api/historical-performance');
        const data = await response.json();
        
        if (data.success) {
            const tbody = document.getElementById('historicalResults');
            tbody.innerHTML = '';
            
            data.results.forEach(result => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${result.invoice_no}</td>
                    <td>${result.llm_model_used}</td>
                    <td>${result.processing_time || 'N/A'}</td>
                    <td>${(result.extraction_confidence * 100).toFixed(1)}%</td>
                    <td>${new Date(result.processing_timestamp).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-info" onclick="window.open('/llm-pdf/results/${result.invoice_no}', '_blank')">
                            <i class="fas fa-eye"></i> View
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
    } catch (error) {
        console.error('Error loading historical data:', error);
    }
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadModelsForComparison();
    loadHistoricalData();
});
</script>
{% endblock %}
